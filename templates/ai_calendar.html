{% extends "base.html" %}
{% block title %}AI Calendar Generator - Georgia Parenting Time{% endblock %}

{% block content %}
<style>
:root {
    --primary: #667eea;
    --primary-dark: #5a67d8;
    --success: #27ae60;
    --warning: #f39c12;
    --danger: #e74c3c;
    --gray-50: #f9fafb;
    --gray-100: #f3f4f6;
    --gray-200: #e5e7eb;
    --gray-300: #d1d5db;
    --gray-400: #9ca3af;
    --gray-500: #6b7280;
    --gray-600: #4b5563;
    --gray-700: #374151;
    --gray-800: #1f2937;
    --parent-a-bg: #fef3c7;
    --parent-b-bg: #dbeafe;
    --radius: 8px;
}

.ai-calendar-page {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

.page-header {
    text-align: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid var(--gray-200);
}

.page-header h1 { font-size: 1.5rem; color: var(--gray-800); margin-bottom: 5px; }
.page-header .subtitle { color: var(--gray-500); font-size: 0.9rem; }

.document-analyzer {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: var(--radius);
    padding: 20px;
    margin-bottom: 25px;
    color: white;
}
.document-analyzer h2 { margin-top: 0; color: white; font-size: 1.25rem; }
.document-analyzer p { color: rgba(255,255,255,0.9); margin: 5px 0; }

.upload-area {
    background: rgba(255,255,255,0.15);
    border: 2px dashed rgba(255,255,255,0.5);
    border-radius: var(--radius);
    padding: 20px;
    text-align: center;
    margin: 15px 0;
    cursor: pointer;
    transition: all 0.3s;
}
.upload-area:hover { background: rgba(255,255,255,0.25); border-color: rgba(255,255,255,0.8); }
.upload-area input[type="file"] { display: none; }
.upload-area label { cursor: pointer; display: block; padding: 10px; }

.upload-btn {
    background: white;
    color: var(--primary);
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    font-weight: bold;
    cursor: pointer;
    margin: 5px;
    transition: all 0.3s;
}
.upload-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
.upload-btn:disabled { background: #ccc; cursor: not-allowed; transform: none; }
.upload-btn.success { background: var(--success); color: white; }

.spinner { display: none; text-align: center; padding: 20px; }
.spinner-icon {
    border: 4px solid rgba(255,255,255,0.3);
    border-top: 4px solid white;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 0 auto 10px;
}
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

.analysis-results {
    background: rgba(255,255,255,0.95);
    color: #000;
    border-radius: var(--radius);
    padding: 20px;
    margin-top: 15px;
    display: none;
}
.analysis-results h3, .analysis-results h4, .analysis-results p { color: #000; }
.confidence-high { color: var(--success); font-weight: bold; }
.confidence-medium { color: var(--warning); font-weight: bold; }
.confidence-low { color: var(--danger); font-weight: bold; }

.config-section {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
    margin-bottom: 25px;
}

.card {
    background: white;
    border: 1px solid var(--gray-200);
    border-radius: var(--radius);
    padding: 15px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
.card h3 {
    font-size: 1rem;
    color: var(--gray-800);
    margin: 0 0 12px 0;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--gray-100);
}
.card p { font-size: 0.85rem; color: var(--gray-600); margin: 5px 0; }

.form-group { margin-bottom: 12px; }
.form-group label { display: block; font-size: 0.85rem; color: var(--gray-700); margin-bottom: 4px; }
.form-group select, .form-group input[type="number"], .form-group input[type="date"] {
    padding: 6px 10px;
    border: 1px solid var(--gray-300);
    border-radius: 4px;
    font-size: 0.85rem;
    background: white;
}

.radio-group { display: flex; flex-wrap: wrap; gap: 8px; margin: 8px 0; }
.radio-group label {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 0.85rem;
    padding: 4px 8px;
    border: 1px solid var(--gray-200);
    border-radius: 4px;
    cursor: pointer;
}
.radio-group label:hover { background: var(--gray-50); }

.day-row { display: flex; align-items: center; gap: 8px; margin: 6px 0; font-size: 0.85rem; }
.day-row input[type="checkbox"] { margin-right: 4px; }
.day-row input[type="number"] { width: 60px; padding: 4px 6px; }

.break-section {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
    margin-bottom: 20px;
}
.break-card {
    background: white;
    border: 1px solid var(--gray-200);
    border-radius: var(--radius);
    padding: 15px;
}
.break-card h3 { font-size: 0.95rem; color: var(--gray-800); margin: 0 0 10px 0; }
.break-card p { font-size: 0.8rem; color: var(--gray-500); margin: 0 0 10px 0; }
.date-row { display: flex; gap: 15px; margin-top: 10px; }
.date-row label { font-size: 0.8rem; color: var(--gray-600); }
.date-row input[type="date"] { margin-top: 2px; }

.split-fields { margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px; border: 1px dashed rgba(0,0,0,0.2); }
.split-row { display: flex; gap: 15px; }
.split-row label { font-size: 0.8rem; color: var(--gray-600); }
.split-row select { margin-top: 2px; padding: 5px; border-radius: 4px; border: 1px solid #ccc; }

.actions-bar {
    display: flex;
    gap: 15px;
    justify-content: center;
    flex-wrap: wrap;
    margin: 25px 0;
    padding: 20px;
    background: var(--gray-50);
    border-radius: var(--radius);
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: var(--radius);
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
}
.btn-primary { background: var(--primary); color: white; }
.btn-primary:hover { background: var(--primary-dark); }
.btn-secondary { background: var(--gray-200); color: var(--gray-700); }
.btn-success { background: var(--success); color: white; }

.results-summary {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 15px;
    margin-bottom: 25px;
}
.result-card {
    background: white;
    border: 1px solid var(--gray-200);
    border-radius: var(--radius);
    padding: 15px;
    text-align: center;
}
.result-card .value { font-size: 1.4rem; font-weight: 600; color: var(--primary); }
.result-card .label { font-size: 0.75rem; color: var(--gray-500); margin-top: 5px; }

.holiday-section {
    background: white;
    border: 1px solid var(--gray-200);
    border-radius: var(--radius);
    margin-bottom: 20px;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}
.holiday-table {
    min-width: 500px;
}
.holiday-section h3 {
    background: var(--gray-100);
    margin: 0;
    padding: 12px 15px;
    font-size: 0.95rem;
    color: var(--gray-800);
    border-bottom: 1px solid var(--gray-200);
}
.holiday-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.85rem;
}
.holiday-table th {
    background: var(--gray-50);
    padding: 8px 10px;
    text-align: left;
    font-weight: 500;
    color: var(--gray-600);
    border-bottom: 1px solid var(--gray-200);
}
.holiday-table td {
    padding: 6px 10px;
    border-bottom: 1px solid var(--gray-100);
}
.holiday-table input[type="date"] { padding: 4px; font-size: 0.8rem; }

.calendar-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
    margin-top: 25px;
}
.month-card {
    background: white;
    border: 1px solid var(--gray-200);
    border-radius: var(--radius);
    overflow: hidden;
}
.month-header {
    background: var(--gray-800);
    color: white;
    padding: 8px;
    text-align: center;
    font-weight: 600;
    font-size: 0.85rem;
}
.month-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 1px;
    background: var(--gray-200);
}
.day-header {
    background: var(--gray-100);
    padding: 4px;
    text-align: center;
    font-size: 0.65rem;
    font-weight: 600;
    color: var(--gray-600);
}
.day-cell {
    background: white;
    padding: 2px;
    min-height: 38px;
    position: relative;
}
.day-cell.empty { background: var(--gray-50); }
.day-cell .day-number { font-size: 0.65rem; color: var(--gray-500); position: absolute; top: 1px; left: 3px; }
.day-cell.parent-a { background: var(--parent-a-bg); }
.day-cell.parent-b { background: var(--parent-b-bg); }
.day-cell input[type="number"] {
    width: 100%;
    height: 100%;
    border: none;
    background: transparent;
    text-align: center;
    font-size: 0.75rem;
    font-weight: 600;
    padding-top: 12px;
}
.day-cell input[type="number"]:focus { outline: 2px solid var(--primary); background: white; }
.day-cell.disabled-cell {
    background: var(--gray-200) !important;
    opacity: 0.5;
    pointer-events: none;
}
.day-cell.disabled-cell input[type="number"] {
    cursor: not-allowed;
}
.day-cell.disabled-cell .day-number {
    color: var(--gray-400);
}
.month-total {
    padding: 6px;
    text-align: center;
    background: var(--gray-50);
    font-size: 0.75rem;
    color: var(--gray-600);
    border-top: 1px solid var(--gray-200);
}
.month-total .total-value { font-weight: 600; color: var(--gray-800); }

.notes-section { font-size: 0.8rem; color: var(--gray-600); margin-top: 20px; padding: 15px; background: var(--gray-50); border-radius: var(--radius); }
.notes-section p { margin: 5px 0; }

/* Methodology Transparency Section */
.methodology-section {
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    border: 1px solid #0284c7;
    border-radius: var(--radius);
    padding: 20px;
    margin-top: 25px;
}
.methodology-section h3 {
    color: #0369a1;
    margin: 0 0 15px 0;
    font-size: 1.1rem;
    display: flex;
    align-items: center;
    gap: 8px;
}
.methodology-section h4 {
    color: #0c4a6e;
    margin: 15px 0 8px 0;
    font-size: 0.95rem;
}
.methodology-section p, .methodology-section li {
    color: #1e3a5f;
    margin: 5px 0;
    line-height: 1.6;
}
.methodology-section ul {
    margin: 8px 0;
    padding-left: 20px;
}
.methodology-section .highlight-box {
    background: white;
    border-left: 4px solid #0284c7;
    padding: 12px 15px;
    margin: 12px 0;
    border-radius: 0 6px 6px 0;
}

/* Georgia Parenting Time Definition Box - Above the Fold */
.definition-box {
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    border: 2px solid #0284c7;
    border-radius: var(--radius);
    padding: 15px 20px;
    margin-bottom: 20px;
}
.definition-box h3 {
    color: #0369a1;
    margin: 0;
    font-size: 1rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    cursor: pointer;
}
.definition-box h3::after {
    content: '+';
    font-size: 1.3rem;
    color: #0284c7;
    font-weight: bold;
}
.definition-box.expanded h3::after {
    content: 'âˆ’';
}
.definition-box-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease, padding 0.3s ease;
    padding: 0;
}
.definition-box.expanded .definition-box-content {
    max-height: 600px;
    padding-top: 15px;
}
.definition-box p {
    color: #1e3a5f;
    margin: 8px 0;
    line-height: 1.6;
    font-size: 0.9rem;
}
.definition-box .statute-quote {
    background: white;
    border-left: 4px solid #0284c7;
    padding: 12px 15px;
    margin: 12px 0;
    border-radius: 0 6px 6px 0;
    font-style: italic;
    color: #0c4a6e;
}
.definition-box .statute-quote strong {
    font-style: normal;
}
.definition-box .calculator-note {
    background: #dbeafe;
    border-radius: 6px;
    padding: 12px 15px;
    margin-top: 12px;
    font-size: 0.85rem;
    color: #1e40af;
}

/* FAQ Section (screen only) */
.faq-section {
    margin-top: 30px;
    border-top: 2px solid var(--gray-200);
    padding-top: 25px;
}
.faq-section h2 {
    color: var(--gray-800);
    margin: 0 0 20px 0;
    font-size: 1.3rem;
}
.faq-item {
    background: white;
    border: 1px solid var(--gray-200);
    border-radius: var(--radius);
    margin-bottom: 12px;
    overflow: hidden;
}
.faq-question {
    padding: 15px 20px;
    font-weight: 600;
    color: var(--gray-800);
    background: var(--gray-50);
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.faq-question:hover {
    background: var(--gray-100);
}
.faq-question::after {
    content: '+';
    font-size: 1.2rem;
    color: var(--primary);
}
.faq-item.active .faq-question::after {
    content: 'âˆ’';
}
.faq-answer {
    padding: 0 20px;
    max-height: 0;
    overflow: hidden;
    transition: all 0.3s ease;
    color: var(--gray-600);
    line-height: 1.6;
}
.faq-item.active .faq-answer {
    padding: 15px 20px;
    max-height: 500px;
}

.screen-only { display: block; }
.print-only { display: none; }
.print-value { display: none; }

.analyzer-cards-container {
    display: grid;
    grid-template-columns: 1fr;
    gap: 20px;
    margin-bottom: 25px;
}
@media (min-width: 1024px) {
    .analyzer-cards-container {
        grid-template-columns: 1fr 1fr;
    }
}

.school-calendar-section {
    background: linear-gradient(135deg, #059669 0%, #0d9488 100%);
    border-radius: var(--radius);
    padding: 20px;
    margin-bottom: 0;
    color: white;
}
.school-calendar-section h2 { margin-top: 0; color: white; font-size: 1.25rem; }
.school-calendar-section p { color: rgba(255,255,255,0.9); margin: 5px 0; }

.legacy-toggle {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-top: 15px;
    padding: 12px 16px;
    background: rgba(255,255,255,0.15);
    border-radius: 6px;
}
.legacy-toggle label {
    color: white;
    font-weight: 500;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
}
.toggle-switch {
    position: relative;
    width: 50px;
    height: 26px;
    background: rgba(255,255,255,0.3);
    border-radius: 13px;
    cursor: pointer;
    transition: all 0.3s;
}
.toggle-switch.active {
    background: #27ae60;
}
.toggle-switch::before {
    content: '';
    position: absolute;
    width: 22px;
    height: 22px;
    background: white;
    border-radius: 50%;
    top: 2px;
    left: 2px;
    transition: all 0.3s;
}
.toggle-switch.active::before {
    left: 26px;
}

.toggle-switch-small::before {
    content: '';
    position: absolute;
    width: 14px;
    height: 14px;
    background: white;
    border-radius: 50%;
    top: 2px;
    left: 2px;
    transition: all 0.3s;
}
.toggle-switch-small.active {
    background: #27ae60 !important;
}
.toggle-switch-small.active::before {
    left: 20px;
}

.county-selector-section {
    background: rgba(255,255,255,0.95);
    color: #333;
    padding: 15px;
    border-radius: 6px;
    margin-top: 15px;
}
.county-selector-section h4 { margin: 0 0 10px 0; color: #374151; }
.county-selector-section select { padding: 8px 12px; border-radius: 4px; border: 1px solid #d1d5db; font-size: 0.9rem; }

.calendar-extractor {
    margin-top: 15px;
}
.calendar-extractor .upload-area {
    background: rgba(255,255,255,0.15);
    border: 2px dashed rgba(255,255,255,0.5);
    border-radius: var(--radius);
    padding: 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
}
.calendar-extractor .upload-area:hover { background: rgba(255,255,255,0.25); border-color: rgba(255,255,255,0.8); }

.extraction-results {
    background: rgba(255,255,255,0.95);
    color: #000;
    border-radius: var(--radius);
    padding: 20px;
    margin-top: 15px;
    display: none;
}
.extraction-results h3, .extraction-results h4, .extraction-results p { color: #000; }
.extracted-holidays-list {
    max-height: 300px;
    overflow-y: auto;
    margin: 10px 0;
}
.extracted-holiday-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 12px;
    background: #f3f4f6;
    border-radius: 4px;
    margin-bottom: 6px;
}
.extracted-holiday-item.omitted {
    background: #fef3c7;
    border-left: 3px solid #f59e0b;
}
.extracted-holiday-item.inferred {
    background: #ede9fe;
    border-left: 3px solid #8b5cf6;
}
.inferred-symbol {
    color: #8b5cf6;
    font-size: 0.9rem;
    margin-left: 5px;
    cursor: help;
}
.inferred-legend {
    font-size: 0.85rem;
    color: #6b7280;
    font-style: italic;
    margin-top: 10px;
}
.inferred-legend .inferred-symbol {
    font-style: normal;
}
.extracted-holiday-item.verified {
    background: #ecfdf5;
    border-left: 3px solid #10b981;
}
.verified-symbol {
    color: #10b981;
    font-size: 0.9rem;
    margin-left: 5px;
    cursor: help;
}
.verified-legend {
    font-size: 0.85rem;
    color: #6b7280;
    font-style: italic;
    margin-top: 10px;
}
.verified-legend .verified-symbol {
    font-style: normal;
}
.holiday-name { font-weight: 500; }
.holiday-dates { font-size: 0.85rem; color: #6b7280; }

.document-analyzer.disabled {
    opacity: 0.7;
    pointer-events: none;
}
.document-analyzer.disabled .upload-area {
    display: none;
}
.document-analyzer .gating-message {
    display: none;
    background: rgba(255,255,255,0.15);
    border: 1px solid rgba(255,255,255,0.3);
    border-radius: 6px;
    padding: 12px 16px;
    margin-bottom: 15px;
    font-size: 0.9rem;
    text-align: center;
}
.document-analyzer.disabled .gating-message {
    display: block;
}
.date-corrections-banner {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    border-radius: 8px;
    padding: 15px 20px;
    margin-bottom: 15px;
    color: white;
    display: none;
}
.date-corrections-banner.visible {
    display: block;
}
.date-corrections-banner h4 {
    margin: 0 0 8px 0;
    font-size: 1rem;
}
.date-corrections-banner .corrections-summary {
    font-size: 0.9rem;
    margin-bottom: 10px;
}
.date-corrections-banner .see-more-btn {
    background: rgba(255,255,255,0.2);
    border: 1px solid rgba(255,255,255,0.5);
    color: white;
    padding: 6px 14px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.85rem;
    transition: all 0.2s;
}
.date-corrections-banner .see-more-btn:hover {
    background: rgba(255,255,255,0.3);
}
.date-corrections-details {
    display: none;
    margin-top: 12px;
    background: rgba(255,255,255,0.1);
    border-radius: 6px;
    padding: 12px;
    max-height: 300px;
    overflow-y: auto;
}
.date-corrections-details.visible {
    display: block;
}
.correction-item {
    background: rgba(255,255,255,0.1);
    border-radius: 4px;
    padding: 10px;
    margin-bottom: 8px;
}
.correction-item:last-child {
    margin-bottom: 0;
}
.correction-item .label {
    font-weight: 600;
    margin-bottom: 4px;
}
.correction-item .dates {
    font-size: 0.85rem;
    opacity: 0.9;
}
.correction-item .reason {
    font-size: 0.8rem;
    font-style: italic;
    opacity: 0.8;
    margin-top: 4px;
}
input[type="date"].ai-adjusted {
    background-color: #d1fae5 !important;
    border-color: #10b981 !important;
    animation: adjustedPulse 2s ease-out;
}
@keyframes adjustedPulse {
    0% { box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.4); }
    100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
}

@media print {
    body { font-size: 9px; margin: 0; padding: 0; }
    nav, .actions-bar, .document-analyzer, .school-calendar-section, .floating-save-btn, .methodology-section, .definition-box, .faq-section, .step-guide, .step-badge { display: none !important; }
    .print-only { display: block !important; }
    .screen-only { display: none !important; }
    .ai-calendar-page { max-width: 100%; padding: 10px; }
    .page-header { margin-bottom: 10px; padding-bottom: 8px; }
    .page-header h1 { font-size: 12px; }
    #manualConfigSection, #breaksAndHolidaysSection { display: block !important; }
    .config-section { display: grid !important; grid-template-columns: 1fr; gap: 10px; }
    .break-section { grid-template-columns: 1fr; gap: 10px; }
    .yearly-average-display { 
        display: block !important; 
        background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%) !important; 
        -webkit-print-color-adjust: exact !important; 
        print-color-adjust: exact !important;
        padding: 15px !important;
        margin: 10px 0 !important;
        page-break-inside: avoid;
        break-inside: avoid;
    }
    .yearly-average-display .party-identifiers { margin-bottom: 10px; }
    .yearly-average-display #yearlyAverageValueTop { font-size: 2rem !important; }
    .results-summary { 
        grid-template-columns: repeat(4, 1fr); 
        gap: 8px; 
        margin-bottom: 10px;
        page-break-before: always !important;
        break-before: page !important;
    }
    .result-card { 
        padding: 8px; 
        page-break-inside: avoid;
        break-inside: avoid;
    }
    .result-card .value { font-size: 11px; }
    .result-card .label { font-size: 7px; }
    
    .card {
        page-break-inside: avoid;
        break-inside: avoid;
    }
    .break-card {
        page-break-inside: avoid;
        break-inside: avoid;
    }
    .holiday-section { 
        box-shadow: none; 
        border: 1px solid #ccc; 
        margin-bottom: 10px; 
        page-break-inside: avoid;
        break-inside: avoid;
    }
    .holiday-section h3 { font-size: 10px; padding: 6px; }
    .holiday-table { font-size: 8px; }
    .holiday-table th, .holiday-table td { padding: 4px; }
    
    #holiday-even-section {
        page-break-after: always !important;
        break-after: page !important;
    }
    
    .calendar-grid { display: block !important; margin-top: 15px; }
    .month-card {
        width: 100% !important;
        margin-bottom: 8px !important;
        page-break-inside: avoid;
        break-inside: avoid;
        box-shadow: none;
        border: 1px solid #ccc;
    }
    .month-header { padding: 5px; font-size: 9px; background: #333 !important; color: white !important; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
    .day-cell { min-height: 20px; padding: 1px; }
    .day-cell .day-number { font-size: 6px; }
    .day-cell input[type="number"] { display: none !important; }
    .day-cell .print-value { display: block !important; font-size: 7px; font-weight: bold; text-align: center; padding-top: 8px; }
    .day-cell.parent-a { background: #fef3c7 !important; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
    .day-cell.parent-b { background: #dbeafe !important; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
    .month-total { display: block !important; font-size: 8px; padding: 4px; }
    .notes-section { 
        font-size: 7px; 
        margin-top: 10px; 
        padding: 10px; 
        page-break-inside: avoid;
        break-inside: avoid;
    }
    .print-footer {
        display: block !important;
        text-align: center;
        padding: 15px;
        margin-top: 20px;
        border-top: 1px solid #ccc;
        font-size: 9px;
        color: #333;
    }
    .print-branding {
        display: block !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
    }
}

@media (max-width: 768px) {
    .calendar-grid { grid-template-columns: 1fr; }
    .config-section { grid-template-columns: 1fr; }
    .break-section { grid-template-columns: 1fr; }
    .results-summary { grid-template-columns: repeat(2, 1fr); }
}

@media (max-width: 768px) and (orientation: portrait) {
    .holiday-section {
        overflow-x: visible;
        overflow: visible;
    }
    .holiday-section h3 {
        position: sticky;
        top: 0;
        z-index: 10;
        background: var(--gray-800);
        color: white;
        margin: 0;
        padding: 12px 15px;
        font-size: 0.95rem;
    }
    .holiday-table {
        min-width: unset;
        display: block;
    }
    .holiday-table thead {
        display: none;
    }
    .holiday-table tbody {
        display: flex;
        flex-direction: column;
        gap: 12px;
        padding: 10px;
    }
    .holiday-table tr {
        display: block;
        background: var(--gray-50);
        border: 1px solid var(--gray-200);
        border-radius: 8px;
        padding: 12px;
    }
    .holiday-table td {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 6px 0;
        border-bottom: 1px solid var(--gray-100);
    }
    .holiday-table td:last-child {
        border-bottom: none;
    }
    .holiday-table td:first-child {
        font-weight: 600;
        color: var(--gray-800);
        font-size: 0.95rem;
        padding-bottom: 10px;
        margin-bottom: 6px;
        border-bottom: 2px solid var(--gray-200);
        display: block;
    }
    .holiday-table td::before {
        content: attr(data-label);
        font-weight: 500;
        color: var(--gray-600);
        font-size: 0.8rem;
    }
    .holiday-table td:first-child::before {
        content: none;
    }
    .holiday-table td input[type="date"] {
        font-size: 0.85rem;
        padding: 6px 8px;
    }
}
</style>

<div class="ai-calendar-page">
    <div class="page-header">
        <h1>Georgia Parenting Time Calendar Tool <span style="font-size: 0.6em; color: var(--primary);">v2.0</span></h1>
        <p class="subtitle">Based upon OCGA 19-6-15(b)(5.1) - {{ current_user.custom_h4 if current_user.custom_h4 else '' }}</p>
    </div>

    <!-- Georgia Parenting Time Definition Box - Above the Fold -->
    <div class="definition-box screen-only" id="definitionBox">
        <h3 onclick="toggleDefinitionBox()">What Counts as a Parenting Time Day in Georgia?</h3>
        <div class="definition-box-content">
            <p>Under OCGA Â§ 19-6-15, parenting time is measured in <strong>days</strong> (not hours) for child support calculations.</p>
            
            <div class="statute-quote">
                <strong>A "day" means:</strong><br>
                (i) The total number of overnights a parent spends with the child; or<br>
                (ii) In circumstances where a parent has shorter but regular and recurring daytime periods with a child, the total hours of parenting time in the annual average divided by 24 hours, including any hours spent overnight, if applicable.
            </div>
            
            <p>The statutory formula requires counting annual parenting time days to determine adjustment eligibility.</p>
            
            <div class="calculator-note">
                <strong>How This Calculator Works:</strong> This calculator includes regular recurring daytime periods (commonly referred to as weekday visitation) as fractional days, which are added to the overnight days. The total annual hours of daytime visitation are divided by 24 to calculate the fractional day credit.
            </div>
        </div>
    </div>

    <!-- 3-Step Process Guide -->
    <div class="step-guide screen-only" style="margin: 25px 0;">
        <h2 style="text-align: center; color: var(--gray-700); font-size: 1.3rem; margin-bottom: 20px;">3 Easy Steps to Calculate Parenting Time</h2>
        <div class="steps-overview" style="display: flex; justify-content: center; gap: 40px; flex-wrap: wrap; margin-bottom: 10px;">
            <div class="step-indicator" style="display: flex; align-items: center; gap: 10px;">
                <div class="step-circle" style="width: 36px; height: 36px; background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.1rem; box-shadow: 0 2px 8px rgba(39, 174, 96, 0.3);">1</div>
                <span style="font-size: 0.9rem; color: var(--gray-600);">Upload School Calendar (PDF or Image)</span>
            </div>
            <div class="step-indicator" style="display: flex; align-items: center; gap: 10px;">
                <div class="step-circle" style="width: 36px; height: 36px; background: linear-gradient(135deg, #9b59b6, #8e44ad); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.1rem; box-shadow: 0 2px 8px rgba(155, 89, 182, 0.3);">2</div>
                <span style="font-size: 0.9rem; color: var(--gray-600);">Auto-Analyze Parenting Plan</span>
            </div>
            <div class="step-indicator" style="display: flex; align-items: center; gap: 10px;">
                <div class="step-circle" style="width: 36px; height: 36px; background: linear-gradient(135deg, #166534, #22c55e); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.1rem; box-shadow: 0 2px 8px rgba(22, 101, 52, 0.3);">3</div>
                <span style="font-size: 0.9rem; color: var(--gray-600);">Print Court-Ready Report</span>
            </div>
        </div>
    </div>

    <div class="analyzer-cards-container screen-only">
    <div class="school-calendar-section" style="position: relative;">
        <div class="step-badge" style="position: absolute; top: -12px; left: 20px; width: 28px; height: 28px; background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.9rem; box-shadow: 0 2px 6px rgba(0,0,0,0.2); z-index: 1;">1</div>
        <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px;">
            <h2 style="margin: 0;">School Calendar Settings</h2>
            <div class="legacy-toggle-inline" style="display: flex; align-items: center; gap: 8px; font-size: 0.8rem;">
                <span class="toggle-switch-small" id="legacyToggle" style="width: 36px; height: 18px; background: rgba(255,255,255,0.3); border-radius: 9px; cursor: pointer; position: relative; transition: all 0.3s;"></span>
                <span style="opacity: 0.8;">Legacy Mode</span>
            </div>
        </div>
        <p>Set break dates by uploading a school calendar PDF or image (PNG, JPG).</p>
        
        <div class="calendar-extractor" id="calendarExtractorSection">
            <div class="upload-area" id="calendarUploadArea">
                <input type="file" id="calendarPdfUpload" accept=".pdf,.png,.jpg,.jpeg,.gif,.webp,image/*">
                <label for="calendarPdfUpload">Click to upload or drag & drop a school calendar PDF or image (PNG, JPG)</label>
                <div class="file-name" id="calendarFileName"></div>
            </div>
            
            <div class="spinner" id="calendarSpinner">
                <div class="spinner-icon"></div>
                <p>Extracting calendar dates...</p>
            </div>
            
            <div class="extraction-results" id="extractionResults">
                <h3>Extracted Holidays & Breaks</h3>
                <div id="extractionContent"></div>
                <div class="extracted-holidays-list" id="extractedHolidaysList"></div>
                <div class="extracted-holidays-collapsed" id="extractedHolidaysCollapsed" style="display: none;"></div>
                <button type="button" class="show-more-btn" id="showMoreHolidaysBtn" style="display: none; background: transparent; border: 1px solid #667eea; color: #667eea; padding: 6px 16px; border-radius: 4px; cursor: pointer; margin-top: 10px; font-size: 0.85rem;">Show More</button>
                <p id="omittedHolidaysNote" style="color: #b45309; font-size: 0.85rem;"></p>
            </div>
        </div>
        
        
        <div class="county-selector-section" id="countySelectorSection" style="display: none;">
            <h4>Select Your School District</h4>
            <select id="school-select" style="min-width: 280px;">
                <option value="">Loading schools...</option>
            </select>
            <p id="schoolHolidaysStatus" style="margin-top: 10px; font-size: 0.85rem; color: #059669;"></p>
        </div>
    </div>

    <div class="document-analyzer disabled" id="documentAnalyzer" style="position: relative;">
        <div class="step-badge" style="position: absolute; top: -12px; left: 20px; width: 28px; height: 28px; background: linear-gradient(135deg, #9b59b6, #8e44ad); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.9rem; box-shadow: 0 2px 6px rgba(0,0,0,0.2); z-index: 1;">2</div>
        <h2>Parenting Plan Analyzer</h2>
        <p>Upload your parenting plan PDF to automatically extract and populate the schedule settings below.</p>
        
        <div class="gating-message" id="gatingMessage">
            Complete School Calendar Settings first (upload a school calendar PDF or enable Legacy Mode) before analyzing your parenting plan.
        </div>
        
        <div class="date-corrections-banner" id="datesCorrectionsBanner">
            <h4>Date Adjustments Applied</h4>
            <div class="corrections-summary" id="correctionsSummary"></div>
            <button type="button" class="see-more-btn" id="seeMoreCorrectionsBtn">See Details</button>
            <div class="date-corrections-details" id="correctionsDetails"></div>
        </div>
        
        <div class="upload-area" id="uploadArea">
            <input type="file" id="pdfUpload" accept=".pdf">
            <label for="pdfUpload">Click to upload or drag & drop your parenting plan PDF</label>
            <div class="file-name" id="fileName"></div>
        </div>
        
        
        <div class="spinner" id="spinner">
            <div class="spinner-icon"></div>
            <p>Analyzing document...</p>
        </div>
        
        <div class="analysis-results" id="analysisResults">
            <h3>Analysis Results</h3>
            <div id="resultsContent"></div>
            <div id="resultsCollapsed" style="display: none;"></div>
            <button type="button" class="show-more-btn" id="showMoreAnalysisBtn" style="display: none; background: transparent; border: 1px solid white; color: white; padding: 6px 16px; border-radius: 4px; cursor: pointer; margin-top: 10px; font-size: 0.85rem;">Show More</button>
        </div>
        
    </div>
    </div>

    <div class="yearly-average-display" id="yearlyAverageTop" style="background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%); border-radius: 8px; padding: 25px; margin: 25px 0; color: white; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 20px; position: relative;">
        <div class="step-badge screen-only" style="position: absolute; top: -12px; left: 20px; width: 28px; height: 28px; background: linear-gradient(135deg, #166534, #22c55e); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.9rem; box-shadow: 0 2px 6px rgba(0,0,0,0.2); z-index: 1;">3</div>
        <div style="flex: 1; min-width: 300px;">
            <div class="party-identifiers" id="partyIdentifiers" style="display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; margin-bottom: 15px;">
                <div id="parent-a-info" style="background: rgba(255,255,255,0.15); padding: 10px 15px; border-radius: 6px; text-align: center; min-width: 180px;">
                    <strong>Parent A:</strong> --<br><small>Custodial</small>
                </div>
                <div id="parent-b-info" style="background: rgba(255,255,255,0.15); padding: 10px 15px; border-radius: 6px; text-align: center; min-width: 180px;">
                    <strong>Parent B:</strong> --<br><small>Non-Custodial</small>
                </div>
            </div>
            <div style="font-size: 3.5rem; font-weight: 700; text-align: center;" id="yearlyAverageValueTop">--</div>
            <div style="font-size: 1rem; opacity: 0.9; margin-top: 5px; text-align: center;">Yearly Average Parenting Days for the "Noncustodial Parent"</div>
        </div>
        <div class="screen-only" style="display: flex; flex-direction: column; gap: 10px;">
            <button class="btn" id="exportPdfBtn" onclick="window.print()" style="background: #166534; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; transition: all 0.3s; line-height: 1.3; text-align: center;">Print<br>Court-Ready<br>Report</button>
            {% if not is_guest %}
            <button class="btn" id="save-btn-top" style="background: #8b5cf6; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px;">
                <span style="font-size: 1rem;">ðŸ’¾</span> Save
            </button>
            {% endif %}
        </div>
    </div>

    <div class="manual-config-header screen-only" style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; padding: 15px; background: var(--gray-100); border-radius: 8px;">
        <h2 style="font-size: 1.1rem; color: var(--gray-700); margin: 0;">Manually Configure & Fine-tune Schedule Options</h2>
        <div style="display: flex; align-items: center; gap: 8px;">
            <span class="toggle-switch" id="manualConfigToggle" style="width: 44px; height: 22px; background: #ccc; border-radius: 11px; cursor: pointer; position: relative; transition: all 0.3s;"></span>
            <span style="font-size: 0.85rem; color: var(--gray-600);">Show Options</span>
        </div>
    </div>
    
    <div class="config-section" id="manualConfigSection" style="display: none;">
        <div class="card">
            <h3>Regular Weekly Schedule</h3>
            <p>Weekend overnights spent with Parent B:</p>
            <div class="radio-group">
                <label><input type="radio" name="weekly-schedule" value="first-third"> 1st & 3rd</label>
                <label><input type="radio" name="weekly-schedule" value="second-fourth"> 2nd & 4th</label>
                <label><input type="radio" name="weekly-schedule" value="alternating-odd"> Alt Odd</label>
                <label><input type="radio" name="weekly-schedule" value="alternating-even"> Alt Even</label>
                <label><input type="radio" name="weekly-schedule" value="every"> Every</label>
                <label><input type="radio" name="weekly-schedule" value="Omit" checked> Omit</label>
            </div>
            <div class="form-group">
                <label>Beginning: <select id="weekend-start">
                    <option value="wednesday">Wednesday</option>
                    <option value="thursday">Thursday</option>
                    <option value="friday" selected>Friday</option>
                    <option value="saturday">Saturday</option>
                </select></label>
                <label style="margin-left: 15px;">Ending: <select id="weekend-end">
                    <option value="saturday">Saturday</option>
                    <option value="sunday" selected>Sunday</option>
                    <option value="monday">Monday</option>
                </select></label>
            </div>
        </div>

        <div class="card">
            <h3>Recurring Daytime Periods</h3>
            <div class="radio-group">
                <label><input type="radio" name="recurring-freq" value="first-third"> 1st & 3rd</label>
                <label><input type="radio" name="recurring-freq" value="second-fourth"> 2nd & 4th</label>
                <label><input type="radio" name="recurring-freq" value="every"> Every Week</label>
                <label><input type="radio" name="recurring-freq" value="every-other"> Every Other</label>
                <label><input type="radio" name="recurring-freq" value="Omit" checked> Omit</label>
            </div>
            <div id="every-other-options" style="display: none; margin: 10px 0; padding: 8px; background: var(--gray-50); border-radius: 4px;">
                <label style="margin-right: 15px;"><input type="radio" name="every-other-type" value="odd" checked> Odd Weeks</label>
                <label><input type="radio" name="every-other-type" value="even"> Even Weeks</label>
            </div>
            <div id="recurring-days">
                <div class="day-row"><label><input type="checkbox" name="recurring-day" value="monday"> Monday</label> for <input type="number" id="hours-monday" min="0" max="24" step="0.5" disabled> hrs</div>
                <div class="day-row"><label><input type="checkbox" name="recurring-day" value="tuesday"> Tuesday</label> for <input type="number" id="hours-tuesday" min="0" max="24" step="0.5" disabled> hrs</div>
                <div class="day-row"><label><input type="checkbox" name="recurring-day" value="wednesday"> Wednesday</label> for <input type="number" id="hours-wednesday" min="0" max="24" step="0.5" disabled> hrs</div>
                <div class="day-row"><label><input type="checkbox" name="recurring-day" value="thursday"> Thursday</label> for <input type="number" id="hours-thursday" min="0" max="24" step="0.5" disabled> hrs</div>
                <div class="day-row"><label><input type="checkbox" name="recurring-day" value="friday"> Friday</label> for <input type="number" id="hours-friday" min="0" max="24" step="0.5" disabled> hrs</div>
                <div class="day-row"><label><input type="checkbox" name="recurring-day" value="saturday"> Saturday</label> for <input type="number" id="hours-saturday" min="0" max="24" step="0.5" disabled> hrs</div>
                <div class="day-row"><label><input type="checkbox" name="recurring-day" value="sunday"> Sunday</label> for <input type="number" id="hours-sunday" min="0" max="24" step="0.5" disabled> hrs</div>
            </div>
        </div>
    </div>

    <div id="breaksAndHolidaysSection" style="display: none;">
    <h3 class="screen-only" style="font-size: 1rem; color: var(--gray-700); margin: 20px 0 15px;">School Breaks (Priority over regular schedule)</h3>
    
    <div class="break-section">
        <div class="break-card">
            <h3>Spring Break - EVEN YEARS</h3>
            <p>Spring Break takes priority over Easter</p>
            <div class="radio-group">
                <label><input type="radio" name="evenSpringBreakParent" value="A"> Parent A</label>
                <label><input type="radio" name="evenSpringBreakParent" value="B"> Parent B</label>
                <label><input type="radio" name="evenSpringBreakParent" value="Omit" checked> Omit</label>
            </div>
            <div class="date-row">
                <div><label>Beginning:</label><br><input type="date" id="evenSpringBreakStart"></div>
                <div><label>Ending:</label><br><input type="date" id="evenSpringBreakEnd"></div>
            </div>
        </div>
        <div class="break-card">
            <h3>Spring Break - ODD YEARS</h3>
            <p>Spring Break takes priority over Easter</p>
            <div class="radio-group">
                <label><input type="radio" name="oddSpringBreakParent" value="A"> Parent A</label>
                <label><input type="radio" name="oddSpringBreakParent" value="B"> Parent B</label>
                <label><input type="radio" name="oddSpringBreakParent" value="Omit" checked> Omit</label>
            </div>
            <div class="date-row">
                <div><label>Beginning:</label><br><input type="date" id="oddSpringBreakStart"></div>
                <div><label>Ending:</label><br><input type="date" id="oddSpringBreakEnd"></div>
            </div>
        </div>
    </div>

    <div class="break-section">
        <div class="break-card">
            <h3>Fall Break - EVEN YEARS</h3>
            <div class="radio-group">
                <label><input type="radio" name="evenFallBreakParent" value="A"> Parent A</label>
                <label><input type="radio" name="evenFallBreakParent" value="B"> Parent B</label>
                <label><input type="radio" name="evenFallBreakParent" value="Omit" checked> Omit</label>
            </div>
            <div class="date-row">
                <div><label>Beginning:</label><br><input type="date" id="evenFallBreakStart"></div>
                <div><label>Ending:</label><br><input type="date" id="evenFallBreakEnd"></div>
            </div>
        </div>
        <div class="break-card">
            <h3>Fall Break - ODD YEARS</h3>
            <div class="radio-group">
                <label><input type="radio" name="oddFallBreakParent" value="A"> Parent A</label>
                <label><input type="radio" name="oddFallBreakParent" value="B"> Parent B</label>
                <label><input type="radio" name="oddFallBreakParent" value="Omit" checked> Omit</label>
            </div>
            <div class="date-row">
                <div><label>Beginning:</label><br><input type="date" id="oddFallBreakStart"></div>
                <div><label>Ending:</label><br><input type="date" id="oddFallBreakEnd"></div>
            </div>
        </div>
    </div>

    <div class="break-section">
        <div class="break-card">
            <h3>Thanksgiving Break - EVEN YEARS</h3>
            <div class="radio-group">
                <label><input type="radio" name="evenThanksgivingBreakParent" value="A" onchange="toggleSplitFields('evenThanksgiving')"> Parent A</label>
                <label><input type="radio" name="evenThanksgivingBreakParent" value="B" onchange="toggleSplitFields('evenThanksgiving')"> Parent B</label>
                <label><input type="radio" name="evenThanksgivingBreakParent" value="Split" onchange="toggleSplitFields('evenThanksgiving')"> Split</label>
                <label><input type="radio" name="evenThanksgivingBreakParent" value="Omit" checked onchange="toggleSplitFields('evenThanksgiving')"> Omit</label>
            </div>
            <div class="date-row">
                <div><label>Beginning:</label><br><input type="date" id="evenThanksgivingBreakStart"></div>
                <div><label>Ending:</label><br><input type="date" id="evenThanksgivingBreakEnd"></div>
            </div>
            <div class="split-fields" id="evenThanksgivingSplitFields" style="display: none;">
                <div class="split-row">
                    <div><label>Exchange Date:</label><br><input type="date" id="evenThanksgivingExchangeDate"></div>
                    <div><label>First Half Parent:</label><br>
                        <select id="evenThanksgivingFirstSplit">
                            <option value="">Select...</option>
                            <option value="A">Parent A</option>
                            <option value="B">Parent B</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        <div class="break-card">
            <h3>Thanksgiving Break - ODD YEARS</h3>
            <div class="radio-group">
                <label><input type="radio" name="oddThanksgivingBreakParent" value="A" onchange="toggleSplitFields('oddThanksgiving')"> Parent A</label>
                <label><input type="radio" name="oddThanksgivingBreakParent" value="B" onchange="toggleSplitFields('oddThanksgiving')"> Parent B</label>
                <label><input type="radio" name="oddThanksgivingBreakParent" value="Split" onchange="toggleSplitFields('oddThanksgiving')"> Split</label>
                <label><input type="radio" name="oddThanksgivingBreakParent" value="Omit" checked onchange="toggleSplitFields('oddThanksgiving')"> Omit</label>
            </div>
            <div class="date-row">
                <div><label>Beginning:</label><br><input type="date" id="oddThanksgivingBreakStart"></div>
                <div><label>Ending:</label><br><input type="date" id="oddThanksgivingBreakEnd"></div>
            </div>
            <div class="split-fields" id="oddThanksgivingSplitFields" style="display: none;">
                <div class="split-row">
                    <div><label>Exchange Date:</label><br><input type="date" id="oddThanksgivingExchangeDate"></div>
                    <div><label>First Half Parent:</label><br>
                        <select id="oddThanksgivingFirstSplit">
                            <option value="">Select...</option>
                            <option value="A">Parent A</option>
                            <option value="B">Parent B</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="break-section">
        <div class="break-card">
            <h3>Christmas/Winter Break - EVEN YEARS</h3>
            <div class="radio-group">
                <label><input type="radio" name="evenChristmasBreakParent" value="A" onchange="toggleSplitFields('evenChristmas')"> Parent A</label>
                <label><input type="radio" name="evenChristmasBreakParent" value="B" onchange="toggleSplitFields('evenChristmas')"> Parent B</label>
                <label><input type="radio" name="evenChristmasBreakParent" value="Split" onchange="toggleSplitFields('evenChristmas')"> Split</label>
                <label><input type="radio" name="evenChristmasBreakParent" value="Omit" checked onchange="toggleSplitFields('evenChristmas')"> Omit</label>
            </div>
            <div class="date-row">
                <div><label>Beginning:</label><br><input type="date" id="evenChristmasBreakStart"></div>
                <div><label>Ending:</label><br><input type="date" id="evenChristmasBreakEnd"></div>
            </div>
            <div class="split-fields" id="evenChristmasSplitFields" style="display: none;">
                <div class="split-row">
                    <div><label>Exchange Date:</label><br><input type="date" id="evenChristmasExchangeDate"></div>
                    <div><label>First Half Parent:</label><br>
                        <select id="evenChristmasFirstSplit">
                            <option value="">Select...</option>
                            <option value="A">Parent A</option>
                            <option value="B">Parent B</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        <div class="break-card">
            <h3>Christmas/Winter Break - ODD YEARS</h3>
            <div class="radio-group">
                <label><input type="radio" name="oddChristmasBreakParent" value="A" onchange="toggleSplitFields('oddChristmas')"> Parent A</label>
                <label><input type="radio" name="oddChristmasBreakParent" value="B" onchange="toggleSplitFields('oddChristmas')"> Parent B</label>
                <label><input type="radio" name="oddChristmasBreakParent" value="Split" onchange="toggleSplitFields('oddChristmas')"> Split</label>
                <label><input type="radio" name="oddChristmasBreakParent" value="Omit" checked onchange="toggleSplitFields('oddChristmas')"> Omit</label>
            </div>
            <div class="date-row">
                <div><label>Beginning:</label><br><input type="date" id="oddChristmasBreakStart"></div>
                <div><label>Ending:</label><br><input type="date" id="oddChristmasBreakEnd"></div>
            </div>
            <div class="split-fields" id="oddChristmasSplitFields" style="display: none;">
                <div class="split-row">
                    <div><label>Exchange Date:</label><br><input type="date" id="oddChristmasExchangeDate"></div>
                    <div><label>First Half Parent:</label><br>
                        <select id="oddChristmasFirstSplit">
                            <option value="">Select...</option>
                            <option value="A">Parent A</option>
                            <option value="B">Parent B</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Hidden fields for current/ongoing break (used when analyzer runs during a break) -->
    <!-- Only one break can be active at a time, so we use a single set of fields -->
    <input type="hidden" id="currentBreakStart">
    <input type="hidden" id="currentBreakEnd">
    <input type="hidden" id="currentBreakType">

    <div class="break-section">
        <div class="break-card">
            <h3>February Winter Break - EVEN YEARS</h3>
            <div class="radio-group">
                <label><input type="radio" name="evenWinterBreakParent" value="A"> Parent A</label>
                <label><input type="radio" name="evenWinterBreakParent" value="B"> Parent B</label>
                <label><input type="radio" name="evenWinterBreakParent" value="Omit" checked> Omit</label>
            </div>
            <div class="date-row">
                <div><label>Beginning:</label><br><input type="date" id="evenWinterBreakStart"></div>
                <div><label>Ending:</label><br><input type="date" id="evenWinterBreakEnd"></div>
            </div>
        </div>
        <div class="break-card">
            <h3>February Winter Break - ODD YEARS</h3>
            <div class="radio-group">
                <label><input type="radio" name="oddWinterBreakParent" value="A"> Parent A</label>
                <label><input type="radio" name="oddWinterBreakParent" value="B"> Parent B</label>
                <label><input type="radio" name="oddWinterBreakParent" value="Omit" checked> Omit</label>
            </div>
            <div class="date-row">
                <div><label>Beginning:</label><br><input type="date" id="oddWinterBreakStart"></div>
                <div><label>Ending:</label><br><input type="date" id="oddWinterBreakEnd"></div>
            </div>
        </div>
    </div>

    <div class="break-section">
        <div class="break-card">
            <h3>March/Other Break - EVEN YEARS</h3>
            <div class="radio-group">
                <label><input type="radio" name="evenOtherBreakParent" value="A"> Parent A</label>
                <label><input type="radio" name="evenOtherBreakParent" value="B"> Parent B</label>
                <label><input type="radio" name="evenOtherBreakParent" value="Omit" checked> Omit</label>
            </div>
            <div class="date-row">
                <div><label>Beginning:</label><br><input type="date" id="evenOtherBreakStart"></div>
                <div><label>Ending:</label><br><input type="date" id="evenOtherBreakEnd"></div>
            </div>
        </div>
        <div class="break-card">
            <h3>March/Other Break - ODD YEARS</h3>
            <div class="radio-group">
                <label><input type="radio" name="oddOtherBreakParent" value="A"> Parent A</label>
                <label><input type="radio" name="oddOtherBreakParent" value="B"> Parent B</label>
                <label><input type="radio" name="oddOtherBreakParent" value="Omit" checked> Omit</label>
            </div>
            <div class="date-row">
                <div><label>Beginning:</label><br><input type="date" id="oddOtherBreakStart"></div>
                <div><label>Ending:</label><br><input type="date" id="oddOtherBreakEnd"></div>
            </div>
        </div>
    </div>

    <h3 class="screen-only" style="font-size: 1rem; color: var(--gray-700); margin: 20px 0 15px;">Summer Schedule</h3>
    
    <div class="break-section">
        <div class="break-card">
            <h3>Summer Schedule - EVEN YEARS</h3>
            <p>Takes priority over regular weekly schedule and July 4th (not Father's Day)</p>
            <div class="radio-group">
                <label><input type="radio" name="evenSummerSchedule" value="1week"> 1 week</label>
                <label><input type="radio" name="evenSummerSchedule" value="2weeks"> 2 weeks</label>
                <label><input type="radio" name="evenSummerSchedule" value="3weeks"> 3 weeks</label>
                <label><input type="radio" name="evenSummerSchedule" value="4weeks"> 4 weeks</label>
                <label><input type="radio" name="evenSummerSchedule" value="alternating"> Alternating</label>
                <label><input type="radio" name="evenSummerSchedule" value="Omit" checked> Omit</label>
            </div>
            <label style="display: block; margin-top: 10px; font-size: 0.8rem;">
                <input type="radio" name="evenSummerSchedule" value="All"> Parent B: First Saturday after school release to last Sunday before school resumes
            </label>
        </div>
        <div class="break-card">
            <h3>Summer Schedule - ODD YEARS</h3>
            <p>Takes priority during June, July, August when selected</p>
            <div class="radio-group">
                <label><input type="radio" name="oddSummerSchedule" value="1week"> 1 week</label>
                <label><input type="radio" name="oddSummerSchedule" value="2weeks"> 2 weeks</label>
                <label><input type="radio" name="oddSummerSchedule" value="3weeks"> 3 weeks</label>
                <label><input type="radio" name="oddSummerSchedule" value="4weeks"> 4 weeks</label>
                <label><input type="radio" name="oddSummerSchedule" value="alternating"> Alternating</label>
                <label><input type="radio" name="oddSummerSchedule" value="Omit" checked> Omit</label>
            </div>
            <label style="display: block; margin-top: 10px; font-size: 0.8rem;">
                <input type="radio" name="oddSummerSchedule" value="All"> Parent B: First Saturday after school release to last Sunday before school resumes
            </label>
        </div>
    </div>

    <div class="holiday-section" id="holiday-even-section">
        <h3>Holiday Schedule - EVEN YEARS</h3>
        <p style="padding: 10px; font-size: 0.85rem; color: var(--gray-600);">Select the parent with whom the child will spend each holiday. Takes priority over regular and summer schedules.</p>
        <table class="holiday-table">
            <thead>
                <tr><th>Holiday</th><th>Parent A</th><th>Parent B</th><th>Omit</th><th>Beginning</th><th>Ending</th></tr>
            </thead>
            <tbody id="even-holidays-body"></tbody>
        </table>
    </div>

    <div class="holiday-section" id="holiday-odd-section">
        <h3>Holiday Schedule - ODD YEARS</h3>
        <p style="padding: 10px; font-size: 0.85rem; color: var(--gray-600);">Select the parent with whom the child will spend each holiday. Takes priority over regular and summer schedules.</p>
        <table class="holiday-table">
            <thead>
                <tr><th>Holiday</th><th>Parent A</th><th>Parent B</th><th>Omit</th><th>Beginning</th><th>Ending</th></tr>
            </thead>
            <tbody id="odd-holidays-body"></tbody>
        </table>
    </div>

    <div class="actions-bar screen-only">
        <button class="btn btn-primary" id="populate-btn">Populate Calendars</button>
        <button class="btn btn-secondary" id="reset-btn">Reset</button>
        <button class="btn" id="print-btn" style="background: #166534; color: white; border: none;">Printable Court-Ready Report</button>
    </div>
    </div>

    <div class="results-summary">
        <div class="print-branding print-only" style="grid-column: 1 / -1; text-align: center; padding: 10px; background: #1e3a5f; color: white; border-radius: 6px; margin-bottom: 10px; font-weight: 600;">
            Generated by parentingtimecalendartool.com
        </div>
        <div class="result-card">
            <div class="value screen-only" id="total-days-display">0.0</div>
            <div class="value print-only" id="total-days-print">0.000</div>
            <div class="label">Total Parent B Days (24 mo)</div>
        </div>
        <div class="result-card">
            <div class="value screen-only" id="average-days-display">0.0</div>
            <div class="value print-only" id="average-days-print">0.000</div>
            <div class="label">Yearly Average</div>
        </div>
        <div class="result-card">
            <div class="value screen-only" id="percent-display">0.0%</div>
            <div class="value print-only" id="percent-print">0.000%</div>
            <div class="label">Parent B %</div>
        </div>
        <div class="result-card">
            <div class="value" id="parent-a-display">0.0</div>
            <div class="label">Parent A Days</div>
        </div>
    </div>

    <div class="calendar-grid" id="calendar-container"></div>

    <div class="notes-section">
        <p><strong>Notes:</strong></p>
        <p>To create a "50/50" alternating weeks schedule, set the Beginning and Ending as the same day of the week.</p>
        <p>The text of any court order takes precedence over this calendar. The calendar is a visualization aid and is non-binding.</p>
        <p>Dates of breaks may vary by school. Default dates are approximate based on historical school calendars.</p>
        <p>This tool does not account for alternating 5th weekends. Add those manually by typing "1" on appropriate dates.</p>
        <p>Summer Schedule gives priority over Holiday Schedule. This may impact Father's Day and July 4th.</p>
    </div>

    <div class="print-footer print-only">
        <strong>parentingtimecalendartool.com</strong> - Georgia Parenting Time Calculator<br>
        This calendar is a visualization aid based on the information provided. The text of any court order takes precedence.
    </div>

    <!-- Methodology Transparency Section -->
    <div class="methodology-section screen-only">
        <h3>How This Calculator Counts Parenting Time Days</h3>
        <p>This calculator uses the methodology required by Georgia law for calculating the parenting time adjustment under OCGA 19-6-15(b)(5.1).</p>
        
        <h4>Two-Year Averaging Requirement</h4>
        <p>Georgia law requires courts to average parenting time over a two-year period. This accounts for:</p>
        <ul>
            <li>Alternating holiday schedules (even/odd years)</li>
            <li>Variations in school calendars and breaks</li>
            <li>Leap year adjustments (730 vs 731 total days)</li>
        </ul>
        <div class="highlight-box">
            <p>This calculator automatically generates 24 consecutive months and calculates the yearly average, which is the figure entered on Child Support Schedule C.</p>
        </div>
        
        <h4>What This Calculator Does NOT Include</h4>
        <ul>
            <li>Alternating 5th weekends (must be added manually)</li>
            <li>Makeup time or compensatory days</li>
            <li>Transportation time between households</li>
            <li>Time when child is at school, daycare, or third-party care</li>
        </ul>
    </div>

    <!-- FAQ Section (Screen Only - Excluded from Print) -->
    <div class="faq-section screen-only">
        <h2>Frequently Asked Questions: Georgia Parenting Time Calculation</h2>
        
        <div class="faq-item">
            <div class="faq-question">How do I calculate parenting time days in Georgia?</div>
            <div class="faq-answer">To calculate parenting time days in Georgia for child support purposes, count each overnight the noncustodial parent has with the child over a 12-month period. Georgia uses the overnight rule, meaning the parent with whom the child sleeps receives credit for that day. For recurring daytime periods without overnights, divide total annual hours by 24 to get fractional day credit. Courts require a two-year average to account for alternating holidays.</div>
        </div>
        
        <div class="faq-item">
            <div class="faq-question">What is the parenting time adjustment in Georgia child support?</div>
            <div class="faq-answer">The parenting time adjustment in Georgia child support allows the presumptive support amount to be adjusted when the noncustodial parent has significant parenting time. Effective January 1, 2026, Georgia law requires courts to calculate this mandatory adjustment using Schedule C. The adjustment reduces the noncustodial parent's obligation based on the percentage of time the child spends with them, replacing the former discretionary "parenting time deviation."</div>
        </div>
        
        <div class="faq-item">
            <div class="faq-question">How many parenting time days triggers an adjustment in Georgia?</div>
            <div class="faq-answer">Under OCGA Â§ 19-6-15(b)(5.1), the parenting time adjustment may apply when parenting time exceeds the threshold specified in the statute. The adjustment percentage is calculated based on the noncustodial parent's share of annual parenting days divided by 365. Courts average parenting time over a 24-month period to determine the applicable adjustment on Schedule C.</div>
        </div>
        
        <div class="faq-item">
            <div class="faq-question">Does Georgia count overnights or 24-hour periods?</div>
            <div class="faq-answer">Georgia counts overnights (not 24-hour periods) when calculating parenting time days for child support adjustment purposes. Under OCGA Â§ 19-6-15, "days" means: (i) the total number of overnights a parent spends with the child, or (ii) for regular recurring daytime periods, the total hours divided by 24. The overnight rule determines which parent receives credit for each calendar day.</div>
        </div>
        
        <div class="faq-item">
            <div class="faq-question">How do holidays affect parenting time calculations in Georgia?</div>
            <div class="faq-answer">Holidays affect Georgia parenting time calculations by adding or subtracting days from the regular schedule. Most parenting plans alternate holidays between parents in even and odd years. This is why Georgia requires courts to average parenting time over a two-year periodâ€”to capture the full effect of alternating holiday schedules. This calculator applies holiday overrides to the weekly schedule to accurately count each parent's days.</div>
        </div>
        
        <div class="faq-item">
            <div class="faq-question">Can I use a calculator for Georgia parenting time?</div>
            <div class="faq-answer">Yes, you can use a Georgia-specific parenting time calculator to count your annual parenting time days. The calculator should account for your regular schedule, holidays, and school calendar. This tool generates 24 consecutive months of calendars, applies the overnight rule, handles alternating even/odd year holidays, and produces the yearly average needed for Child Support Schedule C.</div>
        </div>
        
        <div class="faq-item">
            <div class="faq-question">What is Schedule C in Georgia child support?</div>
            <div class="faq-answer">Child Support Schedule C is the official Georgia worksheet for calculating the parenting time adjustment. Parents enter their annual parenting days (averaged over 2 years), and Schedule C calculates the percentage adjustment applied to the basic child support obligation. The yearly average from this calculator is entered directly on Schedule C.</div>
        </div>
        
        <div class="faq-item">
            <div class="faq-question">What changed in Georgia child support law in 2026?</div>
            <div class="faq-answer">Effective January 1, 2026, Georgia Senate Bill 454 replaced the discretionary "parenting time deviation" with a mandatory "parenting time adjustment." Courts must now calculate and apply the adjustment using Schedule C, making the process formula-driven rather than judge-discretionary. This ensures consistent treatment of parenting time across all Georgia child support cases.</div>
        </div>
        
        <div class="faq-item">
            <div class="faq-question">Do summer vacation days count toward parenting time in Georgia?</div>
            <div class="faq-answer">Yes, summer vacation overnights count toward the noncustodial parent's parenting time. Extended summer periods are a significant factor in the two-year average, often substantially increasing the noncustodial parent's percentage and reducing their child support obligation through the Schedule C adjustment. This calculator allows you to configure summer weeks for each parent.</div>
        </div>
        
        <div class="faq-item">
            <div class="faq-question">Can I use this parenting time calculator for court?</div>
            <div class="faq-answer">This calculator generates court-ready documentation showing parenting time calculations over 24 months. While it produces the yearly average needed for Schedule C, the official Child Support Worksheets must still be completed. The calendar serves as supporting documentation for your Schedule C entries and can be printed without educational content for a clean court presentation.</div>
        </div>
    </div>
</div>

{% if not is_guest %}
<div class="save-modal-overlay" id="saveModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
    <div style="background:white; border-radius:8px; padding:25px; max-width:400px; width:90%; box-shadow:0 10px 40px rgba(0,0,0,0.2);">
        <h3 style="margin:0 0 15px 0; color:#1f2937;">Save Configuration</h3>
        <input type="text" id="saveNameInput" placeholder="Enter a name for this save..." style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:6px; font-size:1rem; margin-bottom:20px; box-sizing:border-box;">
        <div style="display:flex; gap:10px; justify-content:flex-end;">
            <button class="btn btn-secondary" onclick="closeSaveModal()">Cancel</button>
            <button class="btn btn-primary" id="confirmSaveBtn" style="background:#8b5cf6;">Save</button>
        </div>
    </div>
</div>
{% endif %}

<div class="save-notification" id="saveNotification" style="position:fixed; top:20px; right:20px; padding:15px 20px; border-radius:8px; background:#27ae60; color:white; z-index:1001; opacity:0; transform:translateX(100%); transition:all 0.3s ease;"></div>

{% if is_guest %}
<div class="guest-token-display" style="position:fixed; bottom:80px; left:20px; padding:10px 15px; background:#f0f9ff; border:1px solid #3b82f6; border-radius:8px; z-index:999; font-size:0.9rem;">
    <span id="guestTokenCount">{{ guest_tokens }}</span> tokens remaining
    <a href="{{ url_for('auth.register') }}" style="margin-left:10px; color:#3b82f6;">Register for more</a>
</div>

<div class="guest-modal-overlay" id="emailModal" style="display:{% if needs_email %}flex{% else %}none{% endif %}; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); z-index:1002; align-items:center; justify-content:center;">
    <div style="background:white; border-radius:12px; padding:30px; max-width:450px; width:90%; box-shadow:0 20px 60px rgba(0,0,0,0.3);">
        <h3 style="margin:0 0 10px 0; color:#1f2937; font-size:1.5rem;">Get 5 More Tokens</h3>
        <p style="color:#6b7280; margin-bottom:20px;">Enter your email address to continue using the calendar tool.</p>
        <input type="email" id="guestEmailInput" placeholder="your@email.com" style="width:100%; padding:12px; border:2px solid #d1d5db; border-radius:8px; font-size:1rem; margin-bottom:15px; box-sizing:border-box;">
        <div id="emailError" style="color:#ef4444; margin-bottom:10px; display:none;"></div>
        <button class="btn btn-primary" onclick="submitGuestEmail()" style="width:100%; padding:12px; background:#8b5cf6; font-size:1rem;">Submit & Continue</button>
        <p style="margin-top:15px; font-size:0.85rem; color:#9ca3af; text-align:center;">Or <a href="{{ url_for('auth.register') }}" style="color:#8b5cf6;">create a free account</a> for more tokens.</p>
    </div>
</div>

<div class="guest-modal-overlay" id="phoneModal" style="display:{% if needs_phone %}flex{% else %}none{% endif %}; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); z-index:1002; align-items:center; justify-content:center;">
    <div style="background:white; border-radius:12px; padding:30px; max-width:450px; width:90%; box-shadow:0 20px 60px rgba(0,0,0,0.3);">
        <h3 style="margin:0 0 10px 0; color:#1f2937; font-size:1.5rem;">Get 10 More Tokens</h3>
        <p style="color:#6b7280; margin-bottom:20px;">Enter your phone number to continue. We may contact you for feedback on our tool.</p>
        <input type="tel" id="guestPhoneInput" placeholder="(555) 123-4567" style="width:100%; padding:12px; border:2px solid #d1d5db; border-radius:8px; font-size:1rem; margin-bottom:15px; box-sizing:border-box;">
        <label style="display:flex; align-items:flex-start; gap:10px; margin-bottom:15px; cursor:pointer;">
            <input type="checkbox" id="contactPermission" style="margin-top:4px;">
            <span style="color:#4b5563; font-size:0.9rem;">I give permission for the creator of this website to contact me for feedback about this tool.</span>
        </label>
        <div id="phoneError" style="color:#ef4444; margin-bottom:10px; display:none;"></div>
        <button class="btn btn-primary" onclick="submitGuestPhone()" style="width:100%; padding:12px; background:#8b5cf6; font-size:1rem;">Submit & Continue</button>
        <p style="margin-top:15px; font-size:0.85rem; color:#9ca3af; text-align:center;">Or <a href="{{ url_for('auth.register') }}" style="color:#8b5cf6;">create a free account</a> for more tokens.</p>
    </div>
</div>
{% endif %}

<script>
const MONTHS = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
const DAYS = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
const DAY_MAP = { sunday: 0, monday: 1, tuesday: 2, wednesday: 3, thursday: 4, friday: 5, saturday: 6 };

// Holiday definitions - dates are calculated dynamically
const HOLIDAYS = [
    { name: 'MLK Day Weekend', type: 'mlk' },
    { name: "Presidents' Day Weekend", type: 'presidents' },
    { name: 'Easter Weekend', type: 'easter' },
    { name: "Mother's Day Weekend", type: 'mothers' },
    { name: 'Memorial Day Weekend', type: 'memorial' },
    { name: "Father's Day Weekend", type: 'fathers' },
    { name: 'Fourth of July', type: 'july4' },
    { name: 'Labor Day Weekend', type: 'labor' },
    { name: 'Halloween', type: 'halloween' },
    { name: 'Veterans Day', type: 'veterans' }
];

// Calculate the actual date of each holiday for a given year
function getHolidayDate(type, year) {
    switch (type) {
        case 'mlk': // 3rd Monday of January
            return getNthWeekdayOfMonth(year, 0, 1, 3);
        case 'presidents': // 3rd Monday of February
            return getNthWeekdayOfMonth(year, 1, 1, 3);
        case 'easter': // Complex calculation
            return getEasterDate(year);
        case 'mothers': // 2nd Sunday of May
            return getNthWeekdayOfMonth(year, 4, 0, 2);
        case 'memorial': // Last Monday of May
            return getLastWeekdayOfMonth(year, 4, 1);
        case 'fathers': // 3rd Sunday of June
            return getNthWeekdayOfMonth(year, 5, 0, 3);
        case 'july4': // July 4th
            return new Date(year, 6, 4);
        case 'labor': // 1st Monday of September
            return getNthWeekdayOfMonth(year, 8, 1, 1);
        case 'halloween': // October 31st
            return new Date(year, 9, 31);
        case 'veterans': // November 11th
            return new Date(year, 10, 11);
        default:
            return null;
    }
}

// Get the last occurrence of a weekday in a month
function getLastWeekdayOfMonth(year, month, weekday) {
    const lastDay = new Date(year, month + 1, 0); // Last day of month
    const lastDayOfWeek = lastDay.getDay();
    const diff = (lastDayOfWeek - weekday + 7) % 7;
    return new Date(year, month, lastDay.getDate() - diff);
}

// Calculate Easter Sunday (Anonymous Gregorian algorithm)
function getEasterDate(year) {
    const a = year % 19;
    const b = Math.floor(year / 100);
    const c = year % 100;
    const d = Math.floor(b / 4);
    const e = b % 4;
    const f = Math.floor((b + 8) / 25);
    const g = Math.floor((b - f + 1) / 3);
    const h = (19 * a + b - d - g + 15) % 30;
    const i = Math.floor(c / 4);
    const k = c % 4;
    const l = (32 + 2 * e + 2 * i - h - k) % 7;
    const m = Math.floor((a + 11 * h + 22 * l) / 451);
    const month = Math.floor((h + l - 7 * m + 114) / 31) - 1;
    const day = ((h + l - 7 * m + 114) % 31) + 1;
    return new Date(year, month, day);
}

// Calculate holiday break start and end dates based on the weekly schedule
function calculateHolidayBreak(holidayDate, weekendStartDay, weekendEndDay) {
    const holidayDayOfWeek = holidayDate.getDay(); // 0=Sun, 1=Mon, ..., 6=Sat
    const startDayNum = DAY_MAP[weekendStartDay] ?? 5; // Default Friday
    const endDayNum = DAY_MAP[weekendEndDay] ?? 0; // Default Sunday

    let breakStart, breakEnd;

    // Determine break based on what day of week the holiday falls on
    if (holidayDayOfWeek === 0 || holidayDayOfWeek === 1) {
        // Sunday or Monday holiday - absorbs the preceding weekend
        // Break starts on the weekly schedule start day PRIOR to the holiday
        breakStart = new Date(holidayDate);
        const daysBack = (holidayDayOfWeek - startDayNum + 7) % 7;
        breakStart.setDate(holidayDate.getDate() - daysBack);

        // Break ends on holiday, unless holiday falls ON the schedule ending day
        // (then extend by one day because school dropoff moves to next day)
        breakEnd = new Date(holidayDate);
        if (holidayDayOfWeek === endDayNum) {
            breakEnd.setDate(holidayDate.getDate() + 1);
        }
    } else if (holidayDayOfWeek === 5) {
        // Friday holiday - absorbs the entire Regular Weekly Schedule range
        // Break starts on the Beginning day (could be Wed, Thu, or Fri)
        breakStart = new Date(holidayDate);
        const daysBackFromFri = (5 - startDayNum + 7) % 7;
        breakStart.setDate(holidayDate.getDate() - daysBackFromFri);
        // Break ends on the schedule ending day (Sunday or Monday)
        breakEnd = new Date(holidayDate);
        const daysToEnd = (endDayNum - 5 + 7) % 7;
        breakEnd.setDate(holidayDate.getDate() + (daysToEnd === 0 ? 2 : daysToEnd)); // At least to Sunday
    } else if (holidayDayOfWeek === 6) {
        // Saturday holiday - absorbs the entire Regular Weekly Schedule range
        // Break starts on the Beginning day (could be Wed, Thu, Fri, or Sat)
        breakStart = new Date(holidayDate);
        const daysBackFromSat = (6 - startDayNum + 7) % 7;
        breakStart.setDate(holidayDate.getDate() - daysBackFromSat);
        // Break ends on the schedule ending day (Sunday or Monday)
        breakEnd = new Date(holidayDate);
        const daysToEnd = (endDayNum - 6 + 7) % 7;
        breakEnd.setDate(holidayDate.getDate() + (daysToEnd === 0 ? 1 : daysToEnd)); // At least to Sunday
    } else {
        // Tuesday, Wednesday, or Thursday holiday (mid-week)
        // Break is just the holiday and the following day
        breakStart = new Date(holidayDate);
        breakEnd = new Date(holidayDate);
        breakEnd.setDate(holidayDate.getDate() + 1);
    }

    return { start: breakStart, end: breakEnd };
}

// Populate all holiday dates based on current weekly schedule settings
function populateAllHolidayDates() {
    const weekendStart = document.getElementById('weekend-start')?.value || 'friday';
    const weekendEnd = document.getElementById('weekend-end')?.value || 'sunday';

    const today = getEffectiveToday();
    const currentYear = today.getFullYear();

    // Determine even and odd years for the 24-month window
    let evenYear, oddYear;
    if (currentYear % 2 === 0) {
        evenYear = currentYear;
        oddYear = currentYear + 1;
    } else {
        oddYear = currentYear;
        evenYear = currentYear + 1;
    }

    // For each holiday, calculate dates and populate fields
    HOLIDAYS.forEach((holiday, idx) => {
        // Get the holiday date for even and odd years
        const evenHolidayDate = getHolidayDate(holiday.type, evenYear);
        const oddHolidayDate = getHolidayDate(holiday.type, oddYear);

        // Handle holidays that might need to roll to next even/odd year if already passed
        let evenDate = evenHolidayDate;
        let oddDate = oddHolidayDate;

        // If the even year holiday has passed, use the next even year
        if (evenDate < today) {
            evenDate = getHolidayDate(holiday.type, evenYear + 2);
        }
        // If the odd year holiday has passed, use the next odd year
        if (oddDate < today) {
            oddDate = getHolidayDate(holiday.type, oddYear + 2);
        }

        // Calculate break periods
        const evenBreak = calculateHolidayBreak(evenDate, weekendStart, weekendEnd);
        const oddBreak = calculateHolidayBreak(oddDate, weekendStart, weekendEnd);

        // Populate form fields
        const evenStartEl = document.getElementById(`evenBegin${idx}`);
        const evenEndEl = document.getElementById(`evenEnd${idx}`);
        const oddStartEl = document.getElementById(`oddBegin${idx}`);
        const oddEndEl = document.getElementById(`oddEnd${idx}`);

        if (evenStartEl) evenStartEl.value = formatDateForInput(evenBreak.start);
        if (evenEndEl) evenEndEl.value = formatDateForInput(evenBreak.end);
        if (oddStartEl) oddStartEl.value = formatDateForInput(oddBreak.start);
        if (oddEndEl) oddEndEl.value = formatDateForInput(oddBreak.end);
    });
}

// Format a Date object as YYYY-MM-DD for input fields
function formatDateForInput(date) {
    return date.toISOString().split('T')[0];
}

let startYear, startMonth;

function getEffectiveToday() {
    if (window.EFFECTIVE_DATE) {
        return new Date(window.EFFECTIVE_DATE.year, window.EFFECTIVE_DATE.month, window.EFFECTIVE_DATE.day);
    }
    return new Date();
}

function init() {
    const today = getEffectiveToday();
    startYear = today.getFullYear();
    startMonth = today.getMonth();
    
    generateCalendarGrid();
    generateHolidayTables();
    setupEventListeners();
    setupRecurringDays();
    updateCalendarReadyState();
}

function generateCalendarGrid() {
    const container = document.getElementById('calendar-container');
    container.innerHTML = '';
    
    let year = startYear, month = startMonth;
    for (let i = 0; i < 25; i++) {
        container.appendChild(createMonthCard(year, month));
        month++;
        if (month > 11) { month = 0; year++; }
    }
}

function createMonthCard(year, month) {
    const card = document.createElement('div');
    card.className = 'month-card';
    card.dataset.year = year;
    card.dataset.month = month;
    
    card.innerHTML = `<div class="month-header">${MONTHS[month]} ${year}</div>`;
    
    const grid = document.createElement('div');
    grid.className = 'month-grid';
    
    DAYS.forEach(d => { grid.innerHTML += `<div class="day-header">${d}</div>`; });
    
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    
    const today = getEffectiveToday();
    today.setHours(0, 0, 0, 0);
    const maxDate = new Date(today);
    maxDate.setDate(maxDate.getDate() + 731);
    
    for (let i = 0; i < firstDay; i++) grid.innerHTML += `<div class="day-cell empty"></div>`;
    
    for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const cellDate = new Date(year, month, day);
        const isPast = cellDate < today;
        const isTooFar = cellDate > maxDate;
        const isDisabled = isPast || isTooFar;
        const disabledClass = isDisabled ? ' disabled-cell' : '';
        const disabledAttr = isDisabled ? ' disabled' : '';
        
        grid.innerHTML += `
            <div class="day-cell${disabledClass}" data-date="${dateStr}">
                <span class="day-number">${day}</span>
                <input type="number" min="0" max="1" step="0.001" value="" data-date="${dateStr}"${disabledAttr}>
                <span class="print-value"></span>
            </div>`;
    }
    
    card.appendChild(grid);
    card.innerHTML += `<div class="month-total">Monthly Total: <span class="total-value">0.000</span></div>`;
    return card;
}

function generateHolidayTables() {
    const evenBody = document.getElementById('even-holidays-body');
    const oddBody = document.getElementById('odd-holidays-body');
    evenBody.innerHTML = '';
    oddBody.innerHTML = '';

    HOLIDAYS.forEach((h, i) => {
        evenBody.innerHTML += createHolidayRow(h, 'even', i);
        oddBody.innerHTML += createHolidayRow(h, 'odd', i);
    });

    // Populate holiday dates after rows are created
    populateAllHolidayDates();
}

function createHolidayRow(h, type, idx) {
    // Date values are populated dynamically by populateAllHolidayDates()
    return `<tr>
        <td>${h.name}</td>
        <td data-label="Parent A"><input type="radio" name="${type}-holiday-${idx}" value="A"></td>
        <td data-label="Parent B"><input type="radio" name="${type}-holiday-${idx}" value="B"></td>
        <td data-label="Omit"><input type="radio" name="${type}-holiday-${idx}" value="omit" checked></td>
        <td data-label="Beginning"><input type="date" id="${type}Begin${idx}"></td>
        <td data-label="Ending"><input type="date" id="${type}End${idx}"></td>
    </tr>`;
}

let isLegacyMode = false;
let extractedCalendarData = null;
let calendarReady = false;

function toggleSplitFields(prefix) {
    const radioName = `${prefix}BreakParent`;
    const selected = document.querySelector(`input[name="${radioName}"]:checked`);
    const splitFieldsDiv = document.getElementById(`${prefix}SplitFields`);
    
    if (splitFieldsDiv) {
        if (selected && selected.value === 'Split') {
            splitFieldsDiv.style.display = 'block';
        } else {
            splitFieldsDiv.style.display = 'none';
        }
    }
}

function updateCalendarReadyState() {
    const hasExtractedData = extractedCalendarData && extractedCalendarData.holidays && extractedCalendarData.holidays.length > 0;
    const hasLegacyData = isLegacyMode;
    calendarReady = hasExtractedData || hasLegacyData;
    
    const docAnalyzer = document.getElementById('documentAnalyzer');
    const uploadArea = document.getElementById('uploadArea');
    const pdfUpload = document.getElementById('pdfUpload');
    
    if (calendarReady) {
        docAnalyzer?.classList.remove('disabled');
        if (uploadArea) uploadArea.style.pointerEvents = 'auto';
        if (pdfUpload) pdfUpload.disabled = false;
    } else {
        docAnalyzer?.classList.add('disabled');
        if (uploadArea) uploadArea.style.pointerEvents = 'none';
        if (pdfUpload) pdfUpload.disabled = true;
    }
}

function collectFormSnapshot() {
    const getSelectedRadio = (name) => {
        const selected = document.querySelector(`input[name="${name}"]:checked`);
        return selected ? selected.value : null;
    };
    
    const getInputValue = (id) => {
        const el = document.getElementById(id);
        return el ? el.value : null;
    };
    
    const weeklySchedule = {
        pattern: getSelectedRadio('weekly-schedule'),
        beginDay: getInputValue('weekend-start'),
        endDay: getInputValue('weekend-end')
    };
    
    const recurringFreq = getSelectedRadio('recurring-freq');
    const everyOtherType = getSelectedRadio('every-other-type');
    const recurringDays = {};
    ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'].forEach(day => {
        const checkbox = document.querySelector(`input[name="recurring-day"][value="${day}"]`);
        const hoursInput = document.getElementById(`hours-${day}`);
        if (checkbox && checkbox.checked) {
            recurringDays[day] = { enabled: true, hours: hoursInput ? parseFloat(hoursInput.value) || 0 : 0 };
        }
    });
    const recurringDaytime = {
        frequency: recurringFreq,
        everyOtherType: everyOtherType,
        days: recurringDays
    };
    
    const breaks = {};
    const breakTypes = ['Spring', 'Fall', 'Thanksgiving', 'Christmas', 'Winter', 'Other'];
    const splittableBreaks = ['Thanksgiving', 'Christmas'];
    const yearTypes = ['even', 'odd'];
    breakTypes.forEach(bt => {
        yearTypes.forEach(yt => {
            const key = `${yt}${bt}`;
            const breakData = {
                parent: getSelectedRadio(`${yt}${bt}BreakParent`),
                startDate: getInputValue(`${yt}${bt}BreakStart`),
                endDate: getInputValue(`${yt}${bt}BreakEnd`)
            };
            if (splittableBreaks.includes(bt)) {
                breakData.exchangeDate = getInputValue(`${yt}${bt}ExchangeDate`);
                breakData.firstSplitParent = getInputValue(`${yt}${bt}FirstSplit`);
            }
            breaks[key] = breakData;
        });
    });
    
    const holidays = {};
    HOLIDAYS.forEach((h, idx) => {
        holidays[`even_${idx}`] = {
            name: h.name,
            parent: getSelectedRadio(`even-holiday-${idx}`),
            startDate: getInputValue(`evenBegin${idx}`),
            endDate: getInputValue(`evenEnd${idx}`)
        };
        holidays[`odd_${idx}`] = {
            name: h.name,
            parent: getSelectedRadio(`odd-holiday-${idx}`),
            startDate: getInputValue(`oddBegin${idx}`),
            endDate: getInputValue(`oddEnd${idx}`)
        };
    });
    
    const summer = {
        evenYears: getSelectedRadio('evenSummerSchedule'),
        oddYears: getSelectedRadio('oddSummerSchedule')
    };
    
    const dateFields = [];
    
    breakTypes.forEach(bt => {
        yearTypes.forEach(yt => {
            const label = `${bt} Break - ${yt.toUpperCase()} YEARS`;
            const hasSplitFields = splittableBreaks.includes(bt);
            dateFields.push({
                label: label,
                startFieldId: `${yt}${bt}BreakStart`,
                endFieldId: `${yt}${bt}BreakEnd`,
                exchangeFieldId: hasSplitFields ? `${yt}${bt}ExchangeDate` : null,
                firstSplitFieldId: hasSplitFields ? `${yt}${bt}FirstSplit` : null,
                startDate: getInputValue(`${yt}${bt}BreakStart`) || null,
                endDate: getInputValue(`${yt}${bt}BreakEnd`) || null,
                exchangeDate: hasSplitFields ? (getInputValue(`${yt}${bt}ExchangeDate`) || null) : null,
                firstSplitParent: hasSplitFields ? (getInputValue(`${yt}${bt}FirstSplit`) || null) : null
            });
        });
    });
    
    HOLIDAYS.forEach((h, idx) => {
        yearTypes.forEach(yt => {
            const prefix = yt === 'even' ? 'even' : 'odd';
            dateFields.push({
                label: `${h.name} - ${yt.toUpperCase()} YEARS`,
                startFieldId: `${prefix}Begin${idx}`,
                endFieldId: `${prefix}End${idx}`,
                exchangeFieldId: null,
                startDate: getInputValue(`${prefix}Begin${idx}`) || null,
                endDate: getInputValue(`${prefix}End${idx}`) || null,
                exchangeDate: null
            });
        });
    });
    
    return {
        calendarSource: isLegacyMode ? 'legacy' : 'extracted',
        schoolCalendar: extractedCalendarData || {},
        form: {
            weeklySchedule: weeklySchedule,
            recurringDaytime: recurringDaytime,
            breaks: breaks,
            holidays: holidays,
            summer: summer
        },
        dateFields: dateFields
    };
}

function setupEventListeners() {
    document.getElementById('populate-btn')?.addEventListener('click', populateCalendars);
    document.getElementById('reset-btn')?.addEventListener('click', resetCalendars);
    document.getElementById('print-btn')?.addEventListener('click', () => window.print());
    document.getElementById('save-btn')?.addEventListener('click', openSaveModal);
    document.getElementById('confirmSaveBtn')?.addEventListener('click', saveConfiguration);
    
    document.getElementById('calendar-container')?.addEventListener('input', e => {
        if (e.target.type === 'number') {
            updateCellDisplay(e.target);
            updateTotals();
        }
    });
    
    document.getElementById('pdfUpload')?.addEventListener('change', e => {
        const file = e.target.files[0];
        if (file) {
            const fileNameEl = document.getElementById('fileName');
            if (fileNameEl) fileNameEl.textContent = file.name;
            const auditBtn = document.getElementById('auditBtn');
            if (auditBtn) auditBtn.disabled = false;
            analyzeDocument();
        }
    });
    
    document.getElementById('showMoreHolidaysBtn')?.addEventListener('click', toggleHolidaysShowMore);
    document.getElementById('showMoreAnalysisBtn')?.addEventListener('click', toggleAnalysisShowMore);

    // Load school entities for legacy mode dropdown
    loadSchoolEntities();

    document.getElementById('school-select')?.addEventListener('change', function() {
        if (this.value) {
            loadSchoolHolidays(this.value);
        }
    });

    // Recalculate holiday dates when weekly schedule beginning/ending changes
    document.getElementById('weekend-start')?.addEventListener('change', populateAllHolidayDates);
    document.getElementById('weekend-end')?.addEventListener('change', populateAllHolidayDates);

    document.querySelectorAll('input[name="recurring-freq"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const everyOtherOptions = document.getElementById('every-other-options');
            everyOtherOptions.style.display = this.value === 'every-other' ? 'block' : 'none';
        });
    });
    
    const saveModal = document.getElementById('saveModal');
    if (saveModal) {
        saveModal.addEventListener('click', function(e) {
            if (e.target === this) closeSaveModal();
        });
    }
    
    const saveNameInput = document.getElementById('saveNameInput');
    if (saveNameInput) {
        saveNameInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') saveConfiguration();
        });
    }
    
    const legacyToggle = document.getElementById('legacyToggle');
    if (legacyToggle) {
        legacyToggle.addEventListener('click', toggleLegacyMode);
    }
    
    const calendarUploadArea = document.getElementById('calendarUploadArea');
    const calendarFileInput = document.getElementById('calendarPdfUpload');
    
    if (calendarUploadArea && calendarFileInput) {
        calendarUploadArea.addEventListener('click', (e) => {
            if (e.target.tagName !== 'LABEL' && e.target.tagName !== 'INPUT') {
                calendarFileInput.click();
            }
        });
        calendarUploadArea.addEventListener('dragover', e => { e.preventDefault(); calendarUploadArea.style.borderColor = 'white'; });
        calendarUploadArea.addEventListener('dragleave', () => calendarUploadArea.style.borderColor = 'rgba(255,255,255,0.5)');
        calendarUploadArea.addEventListener('drop', e => {
            e.preventDefault();
            calendarUploadArea.style.borderColor = 'rgba(255,255,255,0.5)';
            if (e.dataTransfer.files.length > 0) {
                calendarFileInput.files = e.dataTransfer.files;
                handleCalendarFileSelect(e.dataTransfer.files[0]);
            }
        });
        
        calendarFileInput.addEventListener('change', e => {
            if (e.target.files[0]) handleCalendarFileSelect(e.target.files[0]);
        });
    }
    
    document.getElementById('seeMoreCorrectionsBtn')?.addEventListener('click', function() {
        const details = document.getElementById('correctionsDetails');
        if (details.classList.contains('visible')) {
            details.classList.remove('visible');
            this.textContent = 'See Details';
        } else {
            details.classList.add('visible');
            this.textContent = 'Hide Details';
        }
    });
}

function handleCalendarFileSelect(file) {
    document.getElementById('calendarFileName').textContent = file.name;
    extractSchoolCalendar();
}

function toggleLegacyMode() {
    isLegacyMode = !isLegacyMode;
    const toggle = document.getElementById('legacyToggle');
    const countySection = document.getElementById('countySelectorSection');
    const extractorSection = document.getElementById('calendarExtractorSection');

    if (isLegacyMode) {
        toggle.classList.add('active');
        countySection.style.display = 'block';
        extractorSection.style.display = 'none';
        // Load holidays for currently selected school
        const schoolSelect = document.getElementById('school-select');
        if (schoolSelect && schoolSelect.value) {
            loadSchoolHolidays(schoolSelect.value);
        }
    } else {
        toggle.classList.remove('active');
        countySection.style.display = 'none';
        extractorSection.style.display = 'block';
        resetHolidayDates();
    }
    updateCalendarReadyState();
}

function resetHolidayDates() {
    const breakTypes = ['Spring', 'Fall', 'Thanksgiving', 'Christmas', 'Winter', 'Other'];
    const yearTypes = ['even', 'odd'];

    // Reset break dates (these come from school calendars)
    breakTypes.forEach(bt => {
        yearTypes.forEach(yt => {
            const prefix = yt + bt + 'Break';
            const startEl = document.getElementById(prefix + 'Start');
            const endEl = document.getElementById(prefix + 'End');
            if (startEl) startEl.value = '';
            if (endEl) endEl.value = '';
        });
    });

    // Repopulate holiday dates (these are calculated dynamically based on weekly schedule)
    populateAllHolidayDates();
}

async function extractSchoolCalendar() {
    const fileInput = document.getElementById('calendarPdfUpload');
    if (!fileInput.files[0]) return;
    
    const formData = new FormData();
    formData.append('file', fileInput.files[0]);
    
    document.getElementById('calendarSpinner').style.display = 'block';
    document.getElementById('extractionResults').style.display = 'none';
    
    try {
        const response = await fetch('/extract_school_calendar', { method: 'POST', body: formData });
        const data = await response.json();
        
        if (data.error) {
            alert('Extraction failed: ' + data.error);
            return;
        }
        
        extractedCalendarData = data;
        displayExtractionResults(data);
        applyExtractedDates();
        populateCalendars();
        updateCalendarReadyState();
        
    } catch (err) {
        alert('Error extracting calendar: ' + err.message);
    } finally {
        document.getElementById('calendarSpinner').style.display = 'none';
    }
}

function displayExtractionResults(data) {
    const content = document.getElementById('extractionContent');
    const holidaysList = document.getElementById('extractedHolidaysList');
    const omittedNote = document.getElementById('omittedHolidaysNote');
    const showMoreBtn = document.getElementById('showMoreHolidaysBtn');
    
    let schoolInfo = '';
    if (data.schoolName) schoolInfo += `<strong>School:</strong> ${data.schoolName}<br>`;
    if (data.schoolYear) schoolInfo += `<strong>School Year:</strong> ${data.schoolYear}<br>`;
    if (data.confidence) schoolInfo += `<strong>Confidence:</strong> <span class="confidence-${data.confidence}">${data.confidence}</span>`;
    content.innerHTML = schoolInfo || '<p>Calendar data extracted successfully.</p>';
    
    let holidaysHtml = '';
    let hasInferred = false;
    let hasVerified = false;
    const MAX_VISIBLE = 5;

    if (data.holidays && data.holidays.length > 0) {
        data.holidays.forEach((h, idx) => {
            const omittedClass = h.isOmitted ? 'omitted' : '';
            const inferredClass = h.inferred ? 'inferred' : '';
            const verifiedClass = h.verified ? 'verified' : '';
            const inferredSymbol = h.inferred ? '<span class="inferred-symbol" title="Inferred date (estimated from previous year pattern)">â˜…</span>' : '';
            const verifiedSymbol = h.verified ? '<span class="verified-symbol" title="Verified date (from official school calendar)">âœ“</span>' : '';
            if (h.inferred) hasInferred = true;
            if (h.verified) hasVerified = true;
            holidaysHtml += `
                <div class="extracted-holiday-item ${omittedClass} ${inferredClass} ${verifiedClass}">
                    <span class="holiday-name">${h.name}${h.isOmitted ? ' (Omitted)' : ''}${verifiedSymbol}${inferredSymbol}</span>
                    <span class="holiday-dates">${h.startDate} to ${h.endDate}</span>
                </div>
            `;
        });

        if (data.holidays.length > MAX_VISIBLE) {
            holidaysList.style.maxHeight = '150px';
            holidaysList.style.overflow = 'hidden';
            showMoreBtn.style.display = 'inline-block';
            holidaysExpanded = false;
        } else {
            showMoreBtn.style.display = 'none';
        }
    } else {
        holidaysHtml = '<p style="color: #6b7280;">No holidays found in calendar.</p>';
        showMoreBtn.style.display = 'none';
    }
    holidaysList.innerHTML = holidaysHtml;

    let notesHtml = '';
    if (hasVerified) {
        notesHtml += '<p class="verified-legend"><span class="verified-symbol">âœ“</span> = Verified date (from official school calendar)</p>';
    }
    if (hasInferred) {
        notesHtml += '<p class="inferred-legend"><span class="inferred-symbol">â˜…</span> = Inferred date (estimated from previous year pattern)</p>';
    }
    if (data.omittedHolidays && data.omittedHolidays.length > 0) {
        notesHtml += `<p>Holidays not found in calendar: ${data.omittedHolidays.join(', ')}</p>`;
    }
    omittedNote.innerHTML = notesHtml;
    
    document.getElementById('extractionResults').style.display = 'block';
}

function applyExtractedDates() {
    if (!extractedCalendarData || !extractedCalendarData.holidays) {
        alert('No extracted data to apply.');
        return;
    }
    
    const today = getEffectiveToday();
    today.setHours(0, 0, 0, 0);
    
    // Track which breaks we've already assigned to even/odd to detect conflicts
    const assignedBreaks = {
        evenChristmas: null,
        oddChristmas: null,
        evenSpring: null,
        oddSpring: null,
        evenFall: null,
        oddFall: null,
        evenThanksgiving: null,
        oddThanksgiving: null,
        evenWinter: null,
        oddWinter: null,
        evenOther: null,
        oddOther: null
    };
    
    extractedCalendarData.holidays.forEach(holiday => {
        if (holiday.isOmitted) return;
        
        const name = holiday.name.toLowerCase();
        const startDate = holiday.startDate;
        const endDate = holiday.endDate;
        
        if (!startDate || !endDate) return;
        
        const holidayYear = parseInt(startDate.split('-')[0]);
        const yearType = holidayYear % 2 === 0 ? 'even' : 'odd';
        
        // Check if today falls within this break (current/ongoing break)
        const startDateObj = new Date(startDate + 'T00:00:00');
        const endDateObj = new Date(endDate + 'T00:00:00');
        const isCurrentBreak = (today >= startDateObj && today <= endDateObj);
        
        function setBreakDates(breakName) {
            const slotKey = `${yearType}${breakName}`;
            const existingBreak = assignedBreaks[slotKey];
            
            // If this slot already has a break and this is the current break, use current fields
            if (existingBreak && isCurrentBreak) {
                // Store in consolidated current break fields
                document.getElementById('currentBreakStart').value = startDate;
                document.getElementById('currentBreakEnd').value = endDate;
                document.getElementById('currentBreakType').value = breakName + ' Break';
                return;
            }
            
            // If this slot already has a break assigned and this is NOT current, check which is current
            if (existingBreak) {
                const existingStartObj = new Date(existingBreak.startDate + 'T00:00:00');
                const existingEndObj = new Date(existingBreak.endDate + 'T00:00:00');
                const existingIsCurrent = (today >= existingStartObj && today <= existingEndObj);
                
                if (existingIsCurrent) {
                    // Move existing to consolidated current break fields
                    document.getElementById('currentBreakStart').value = existingBreak.startDate;
                    document.getElementById('currentBreakEnd').value = existingBreak.endDate;
                    document.getElementById('currentBreakType').value = breakName + ' Break';
                }
            }
            
            // Set in even/odd fields
            const startEl = document.getElementById(`${yearType}${breakName}BreakStart`);
            const endEl = document.getElementById(`${yearType}${breakName}BreakEnd`);
            if (startEl) startEl.value = startDate;
            if (endEl) endEl.value = endDate;
            
            // Track assignment
            assignedBreaks[slotKey] = { startDate, endDate };
        }
        
        function setHolidayDates(idx) {
            const startEl = document.getElementById(`${yearType}Begin${idx}`);
            const endEl = document.getElementById(`${yearType}End${idx}`);
            if (startEl) startEl.value = startDate;
            if (endEl) endEl.value = endDate;
        }
        
        if (name.includes('spring') && (name.includes('break') || name.includes('recess'))) {
            setBreakDates('Spring');
        } else if ((name.includes('fall') || name.includes('autumn')) && (name.includes('break') || name.includes('recess'))) {
            setBreakDates('Fall');
        } else if (name.includes('thanksgiving')) {
            setBreakDates('Thanksgiving');
        } else if (name.includes('christmas') || name.includes('holiday break') || 
                   (name.includes('winter') && name.includes('break') && name.includes('december'))) {
            setBreakDates('Christmas');
        } else if (name.includes('winter break') && !name.includes('christmas') && !name.includes('december')) {
            setBreakDates('Winter');
        } else if (name.includes('march') && name.includes('break')) {
            // Map March Break to March/Other Break inputs
            setBreakDates('Other');
        } else if (name.includes('mlk') || name.includes('martin luther king') || name.includes('king day')) {
            setHolidayDates(0);
        } else if (name.includes('president')) {
            setHolidayDates(1);
        } else if (name.includes('easter')) {
            setHolidayDates(2);
        } else if (name.includes('mother')) {
            setHolidayDates(3);
        } else if (name.includes('memorial')) {
            setHolidayDates(4);
        } else if (name.includes('father')) {
            setHolidayDates(5);
        } else if (name.includes('july') || name.includes('fourth') || name.includes('4th') || name.includes('independence')) {
            setHolidayDates(6);
        } else if (name.includes('labor')) {
            setHolidayDates(7);
        } else if (name.includes('halloween')) {
            setHolidayDates(8);
        } else if (name.includes('veteran')) {
            setHolidayDates(9);
        }
    });
    
    showSaveNotification('Extracted dates applied to form!');
}

function setupRecurringDays() {
    document.querySelectorAll('input[name="recurring-day"]').forEach(cb => {
        cb.addEventListener('change', function() {
            const day = this.value;
            const input = document.getElementById('hours-' + day);
            input.disabled = !this.checked;
            if (!this.checked) input.value = '';
        });
    });
}

function updateCellDisplay(input) {
    if (input.disabled) return;
    
    const cell = input.parentElement;
    const val = parseFloat(input.value) || 0;
    const printSpan = cell.querySelector('.print-value');
    
    cell.classList.remove('parent-a', 'parent-b');
    if (val > 0) {
        cell.classList.add('parent-b');
        printSpan.textContent = val.toFixed(3);
    } else {
        printSpan.textContent = '';
    }
}

function updateTotals() {
    let total = 0;
    document.querySelectorAll('#calendar-container input[type="number"]:not(:disabled)').forEach(input => {
        total += parseFloat(input.value) || 0;
    });
    
    document.querySelectorAll('.month-card').forEach(card => {
        let monthTotal = 0;
        card.querySelectorAll('input[type="number"]:not(:disabled)').forEach(input => {
            monthTotal += parseFloat(input.value) || 0;
        });
        card.querySelector('.total-value').textContent = monthTotal.toFixed(3);
    });
    
    const enabledCellCount = document.querySelectorAll('#calendar-container input[type="number"]:not(:disabled)').length;
    const totalDays = enabledCellCount;
    const avg = total / 2;
    const pct = (avg / 365) * 100;
    const parentA = totalDays - total;
    
    document.getElementById('total-days-display').textContent = total.toFixed(2);
    document.getElementById('average-days-display').textContent = avg.toFixed(2);
    document.getElementById('percent-display').textContent = pct.toFixed(2) + '%';
    document.getElementById('parent-a-display').textContent = parentA.toFixed(2);
    
    document.getElementById('total-days-print').textContent = total.toFixed(3);
    document.getElementById('average-days-print').textContent = avg.toFixed(3);
    document.getElementById('percent-print').textContent = pct.toFixed(3) + '%';
    
    const yearlyAvgTop = document.getElementById('yearlyAverageValueTop');
    if (yearlyAvgTop) {
        yearlyAvgTop.textContent = avg.toFixed(2) + ' days';
    }
}

let holidaysExpanded = false;
let analysisExpanded = false;

function toggleHolidaysShowMore() {
    holidaysExpanded = !holidaysExpanded;
    const list = document.getElementById('extractedHolidaysList');
    const btn = document.getElementById('showMoreHolidaysBtn');
    if (holidaysExpanded) {
        list.style.maxHeight = 'none';
        btn.textContent = 'Show Less';
    } else {
        list.style.maxHeight = '150px';
        btn.textContent = 'Show More';
    }
}

function toggleAnalysisShowMore() {
    analysisExpanded = !analysisExpanded;
    const content = document.getElementById('resultsContent');
    const collapsed = document.getElementById('resultsCollapsed');
    const btn = document.getElementById('showMoreAnalysisBtn');
    if (analysisExpanded) {
        content.style.display = 'block';
        collapsed.style.display = 'none';
        btn.textContent = 'Show Less';
    } else {
        content.style.display = 'none';
        collapsed.style.display = 'block';
        btn.textContent = 'Show More';
    }
}

function padToTwoDigits(num) {
    return String(num).padStart(2, '0');
}

function getInputByDate(dateStr) {
    return document.querySelector(`input[data-date="${dateStr}"]`);
}

function assignDateRange(startDateString, endDateString, value) {
    const startDate = new Date(startDateString + 'T00:00:00');
    const endDate = new Date(endDateString + 'T00:00:00');
    
    if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) return;
    
    let currentDate = new Date(startDate);
    while (currentDate <= endDate) {
        const dateStr = `${currentDate.getFullYear()}-${padToTwoDigits(currentDate.getMonth() + 1)}-${padToTwoDigits(currentDate.getDate())}`;
        const input = getInputByDate(dateStr);
        if (input && !input.disabled) {
            input.value = value;
            updateCellDisplay(input);
        }
        currentDate.setDate(currentDate.getDate() + 1);
    }
}

function handleBreak(startId, endId, parentId) {
    const startEl = document.getElementById(startId);
    const endEl = document.getElementById(endId);
    const parentEl = document.querySelector(`input[name="${parentId}"]:checked`);
    
    if (!startEl || !endEl || !parentEl) return;
    
    const start = startEl.value;
    const end = endEl.value;
    const parent = parentEl.value;
    
    if (!start || !end || parent === 'Omit') return;
    
    if (parent === 'B') {
        assignDateRange(start, end, 1);
    } else if (parent === 'A') {
        assignDateRange(start, end, 0);
    } else if (parent === 'Split') {
        handleSplitBreakDates(start, end);
    }
}

function handleCurrentBreak() {
    // Handle current/ongoing break stored in hidden fields
    // Uses the same parent setting as the corresponding odd-year break
    const startEl = document.getElementById('currentBreakStart');
    const endEl = document.getElementById('currentBreakEnd');
    const breakTypeEl = document.getElementById('currentBreakType');
    
    if (!startEl || !endEl || !breakTypeEl) return;
    
    const start = startEl.value;
    const end = endEl.value;
    const breakType = breakTypeEl.value;
    
    // Only process if there's data in the hidden fields
    if (!start || !end || !breakType) return;
    
    // Map break type to corresponding odd-year parent selector
    const parentSelectorMap = {
        'Christmas/Winter Break': 'oddChristmasBreakParent',
        'Spring Break': 'oddSpringBreakParent',
        'Fall Break': 'oddFallBreakParent',
        'Thanksgiving Break': 'oddThanksgivingBreakParent',
        'February Winter Break': 'oddWinterBreakParent',
        'March/Other Break': 'oddOtherBreakParent'
    };
    
    const parentSelectorName = parentSelectorMap[breakType];
    if (!parentSelectorName) return;
    
    const parentEl = document.querySelector(`input[name="${parentSelectorName}"]:checked`);
    if (!parentEl) return;
    
    const parent = parentEl.value;
    if (parent === 'Omit') return;
    
    if (parent === 'B') {
        assignDateRange(start, end, 1);
    } else if (parent === 'A') {
        assignDateRange(start, end, 0);
    } else if (parent === 'Split') {
        handleSplitBreakDates(start, end);
    }
}

function handleSplitBreakDates(startStr, endStr) {
    const startDate = new Date(startStr + 'T00:00:00');
    const endDate = new Date(endStr + 'T00:00:00');
    
    if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) return;
    
    const totalDays = Math.round((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
    const midpoint = Math.floor(totalDays / 2);
    
    let currentDate = new Date(startDate);
    for (let i = 0; i < totalDays; i++) {
        const dateStr = `${currentDate.getFullYear()}-${padToTwoDigits(currentDate.getMonth() + 1)}-${padToTwoDigits(currentDate.getDate())}`;
        const input = getInputByDate(dateStr);
        if (input && !input.disabled) {
            input.value = i < midpoint ? 0 : 1;
            updateCellDisplay(input);
        }
        currentDate.setDate(currentDate.getDate() + 1);
    }
}

function handleHolidaySchedule() {
    const holidayRows = document.querySelectorAll('#even-holidays-body tr, #odd-holidays-body tr');
    
    holidayRows.forEach((row, idx) => {
        const cells = row.querySelectorAll('td');
        if (cells.length < 6) return;
        
        const parentA = cells[1].querySelector('input[type="radio"]');
        const parentB = cells[2].querySelector('input[type="radio"]');
        const omit = cells[3].querySelector('input[type="radio"]');
        const startInput = cells[4].querySelector('input[type="date"]');
        const endInput = cells[5].querySelector('input[type="date"]');
        
        if (!startInput || !endInput) return;
        
        const start = startInput.value;
        const end = endInput.value;
        
        if (!start || !end) return;
        
        if (parentB && parentB.checked) {
            assignDateRange(start, end, 1);
        } else if (parentA && parentA.checked) {
            assignDateRange(start, end, 0);
        }
    });
}

function getFirstMondayOfMonth(year, month) {
    const date = new Date(year, month, 1);
    while (date.getDay() !== 1) {
        date.setDate(date.getDate() + 1);
    }
    return date;
}

function getFirstSaturdayOfMonth(year, month) {
    const date = new Date(year, month, 1);
    while (date.getDay() !== 6) {
        date.setDate(date.getDate() + 1);
    }
    return date;
}

function addDays(date, days) {
    const result = new Date(date);
    result.setDate(result.getDate() + days);
    return result;
}

function updateSummerCalendar(startDate, days, value, today) {
    for (let i = 0; i < days; i++) {
        const date = addDays(startDate, i);
        if (date < today) continue;
        
        const dateStr = `${date.getFullYear()}-${padToTwoDigits(date.getMonth() + 1)}-${padToTwoDigits(date.getDate())}`;
        const input = getInputByDate(dateStr);
        if (input && !input.disabled) {
            input.value = value;
            updateCellDisplay(input);
        }
    }
}

function handleEvenYearSummer(option) {
    const today = getEffectiveToday();
    const currentYear = today.getFullYear();
    const calendarYears = 3;
    
    for (let i = 0; i < calendarYears; i++) {
        const year = currentYear + i;
        if (year % 2 !== 0) continue;
        
        const firstMondayJune = getFirstMondayOfMonth(year, 5);
        if (firstMondayJune < today) continue;
        
        switch (option) {
            case 'Omit': break;
            case '1week':
                updateSummerCalendar(firstMondayJune, 7, 1, today);
                updateSummerCalendar(addDays(firstMondayJune, 28), 7, 0, today);
                break;
            case '2weeks':
                updateSummerCalendar(firstMondayJune, 14, 1, today);
                updateSummerCalendar(addDays(firstMondayJune, 28), 14, 0, today);
                break;
            case '3weeks':
                updateSummerCalendar(firstMondayJune, 21, 1, today);
                updateSummerCalendar(addDays(firstMondayJune, 28), 21, 0, today);
                break;
            case '4weeks':
                updateSummerCalendar(firstMondayJune, 28, 1, today);
                updateSummerCalendar(addDays(firstMondayJune, 28), 28, 0, today);
                break;
            case 'alternating':
                for (let j = 0; j < 8; j++) {
                    updateSummerCalendar(addDays(firstMondayJune, j * 7), 7, j % 2, today);
                }
                break;
            case 'All':
                const firstSaturdayJune = getFirstSaturdayOfMonth(year, 5);
                updateSummerCalendar(firstSaturdayJune, 56, 1, today);
                break;
        }
    }
}

function handleOddYearSummer(option) {
    const today = getEffectiveToday();
    const currentYear = today.getFullYear();
    const calendarYears = 3;
    
    for (let i = 0; i < calendarYears; i++) {
        const year = currentYear + i;
        if (year % 2 === 0) continue;
        
        const firstMondayJune = getFirstMondayOfMonth(year, 5);
        if (firstMondayJune < today) continue;
        
        switch (option) {
            case 'Omit': break;
            case '1week':
                updateSummerCalendar(firstMondayJune, 7, 1, today);
                updateSummerCalendar(addDays(firstMondayJune, 28), 7, 0, today);
                break;
            case '2weeks':
                updateSummerCalendar(firstMondayJune, 14, 1, today);
                updateSummerCalendar(addDays(firstMondayJune, 28), 14, 0, today);
                break;
            case '3weeks':
                updateSummerCalendar(firstMondayJune, 21, 1, today);
                updateSummerCalendar(addDays(firstMondayJune, 28), 21, 0, today);
                break;
            case '4weeks':
                updateSummerCalendar(firstMondayJune, 28, 1, today);
                updateSummerCalendar(addDays(firstMondayJune, 28), 28, 0, today);
                break;
            case 'alternating':
                for (let j = 0; j < 8; j++) {
                    updateSummerCalendar(addDays(firstMondayJune, j * 7), 7, j % 2, today);
                }
                break;
            case 'All':
                const firstSaturdayJune = getFirstSaturdayOfMonth(year, 5);
                updateSummerCalendar(firstSaturdayJune, 56, 1, today);
                break;
        }
    }
}

function handleSummerSchedule() {
    const evenOption = document.querySelector('input[name="evenSummerSchedule"]:checked')?.value || 'Omit';
    const oddOption = document.querySelector('input[name="oddSummerSchedule"]:checked')?.value || 'Omit';
    
    handleEvenYearSummer(evenOption);
    handleOddYearSummer(oddOption);
}

function updateCellBackground(input) {
    const cell = input.closest('.day-cell');
    if (!cell || input.disabled) return;
    
    cell.classList.remove('parent-a', 'parent-b');
    
    const value = parseFloat(input.value);
    if (isNaN(value) || input.value === '') return;
    
    if (value >= 0.5) {
        cell.classList.add('parent-b');
    } else if (value === 0) {
        cell.classList.add('parent-a');
    }
}

function getWeekNumber(date) {
    const startDate = new Date(date.getFullYear(), 0, 1);
    const days = Math.floor((date - startDate) / (24 * 60 * 60 * 1000));
    return Math.ceil((days + startDate.getDay() + 1) / 7);
}

function isFirstOrThirdWeek(date, beginDayIndex) {
    const firstDayOfMonth = new Date(date.getFullYear(), date.getMonth(), 1);
    let firstOccurrence = new Date(firstDayOfMonth);
    
    while (firstOccurrence.getDay() !== beginDayIndex) {
        firstOccurrence.setDate(firstOccurrence.getDate() + 1);
    }
    
    let weekCount = 0;
    let currentWeekStart = new Date(firstOccurrence);
    
    while (currentWeekStart.getMonth() === date.getMonth()) {
        weekCount++;
        if (currentWeekStart <= date && date < new Date(currentWeekStart.getTime() + 7 * 24 * 60 * 60 * 1000)) {
            return weekCount === 1 || weekCount === 3;
        }
        currentWeekStart.setDate(currentWeekStart.getDate() + 7);
    }
    return false;
}

function isSecondOrFourthWeek(date, beginDayIndex) {
    const firstDayOfMonth = new Date(date.getFullYear(), date.getMonth(), 1);
    let firstOccurrence = new Date(firstDayOfMonth);
    
    while (firstOccurrence.getDay() !== beginDayIndex) {
        firstOccurrence.setDate(firstOccurrence.getDate() + 1);
    }
    
    let weekCount = 0;
    let currentWeekStart = new Date(firstOccurrence);
    
    while (currentWeekStart.getMonth() === date.getMonth()) {
        weekCount++;
        if (currentWeekStart <= date && date < new Date(currentWeekStart.getTime() + 7 * 24 * 60 * 60 * 1000)) {
            return weekCount === 2 || weekCount === 4;
        }
        currentWeekStart.setDate(currentWeekStart.getDate() + 7);
    }
    return false;
}

function applyRecurringDaytimePeriods() {
    const recurringFreq = document.querySelector('input[name="recurring-freq"]:checked')?.value || 'Omit';
    if (recurringFreq === 'Omit') return;
    
    const checkedDays = document.querySelectorAll('input[name="recurring-day"]:checked');
    if (checkedDays.length === 0) return;
    
    const beginDayIndex = DAY_MAP[document.getElementById('weekend-start').value];
    
    document.querySelectorAll('.day-cell:not(.empty):not(.disabled-cell)').forEach(cell => {
        const dateStr = cell.dataset.date;
        const date = new Date(dateStr + 'T00:00:00');
        const dayOfWeek = date.getDay();
        const input = cell.querySelector('input[type="number"]');
        
        if (!input || input.disabled) return;
        
        checkedDays.forEach(cb => {
            const day = cb.value;
            const hours = parseFloat(document.getElementById('hours-' + day).value) || 0;
            if (hours <= 0 || dayOfWeek !== DAY_MAP[day]) return;
            
            let shouldApply = false;
            
            switch (recurringFreq) {
                case 'every':
                    shouldApply = true;
                    break;
                case 'every-other':
                    const everyOtherType = document.querySelector('input[name="every-other-type"]:checked')?.value;
                    const weekNum = getWeekNumber(date);
                    if (everyOtherType === 'even') {
                        shouldApply = weekNum % 2 === 0;
                    } else {
                        shouldApply = weekNum % 2 !== 0;
                    }
                    break;
                case 'first-third':
                    shouldApply = isFirstOrThirdWeek(date, beginDayIndex);
                    break;
                case 'second-fourth':
                    shouldApply = isSecondOrFourthWeek(date, beginDayIndex);
                    break;
            }
            
            if (shouldApply) {
                const currentValue = parseFloat(input.value) || 0;
                input.value = Math.max(currentValue, hours / 24);
                updateCellDisplay(input);
            }
        });
    });
}

function populateCalendars() {
    document.querySelectorAll('#calendar-container input[type="number"]').forEach(input => {
        input.value = '';
        const cell = input.closest('.day-cell');
        if (cell) cell.classList.remove('parent-a', 'parent-b');
    });
    
    const weeklySchedule = document.querySelector('input[name="weekly-schedule"]:checked')?.value || 'Omit';
    const startDay = document.getElementById('weekend-start').value;
    const endDay = document.getElementById('weekend-end').value;
    
    document.querySelectorAll('.day-cell:not(.empty):not(.disabled-cell)').forEach(cell => {
        const dateStr = cell.dataset.date;
        const date = new Date(dateStr + 'T00:00:00');
        const dayOfWeek = date.getDay();
        const input = cell.querySelector('input[type="number"]');
        
        if (!input || input.disabled) return;
        
        let value = 0;
        
        if (weeklySchedule !== 'Omit') {
            const weekOfMonth = Math.ceil(date.getDate() / 7);
            let isParentBWeekend = false;
            
            if (weeklySchedule === 'first-third') isParentBWeekend = weekOfMonth === 1 || weekOfMonth === 3;
            else if (weeklySchedule === 'second-fourth') isParentBWeekend = weekOfMonth === 2 || weekOfMonth === 4;
            else if (weeklySchedule === 'every') isParentBWeekend = true;
            else if (weeklySchedule === 'alternating-odd') {
                const weekNum = Math.ceil((date.getDate() + new Date(date.getFullYear(), date.getMonth(), 1).getDay()) / 7);
                isParentBWeekend = weekNum % 2 === 1;
            } else if (weeklySchedule === 'alternating-even') {
                const weekNum = Math.ceil((date.getDate() + new Date(date.getFullYear(), date.getMonth(), 1).getDay()) / 7);
                isParentBWeekend = weekNum % 2 === 0;
            }
            
            if (isParentBWeekend) {
                const startDayNum = DAY_MAP[startDay];
                const endDayNum = DAY_MAP[endDay];
                
                if (startDayNum <= endDayNum) {
                    if (dayOfWeek >= startDayNum && dayOfWeek <= endDayNum) value = 1;
                } else {
                    if (dayOfWeek >= startDayNum || dayOfWeek <= endDayNum) value = 1;
                }
            }
        }
        
        if (value > 0) {
            input.value = value;
            updateCellDisplay(input);
        }
    });
    
    applyRecurringDaytimePeriods();
    
    handleBreak('evenSpringBreakStart', 'evenSpringBreakEnd', 'evenSpringBreakParent');
    handleBreak('oddSpringBreakStart', 'oddSpringBreakEnd', 'oddSpringBreakParent');
    handleBreak('evenFallBreakStart', 'evenFallBreakEnd', 'evenFallBreakParent');
    handleBreak('oddFallBreakStart', 'oddFallBreakEnd', 'oddFallBreakParent');
    handleBreak('evenThanksgivingBreakStart', 'evenThanksgivingBreakEnd', 'evenThanksgivingBreakParent');
    handleBreak('oddThanksgivingBreakStart', 'oddThanksgivingBreakEnd', 'oddThanksgivingBreakParent');
    handleBreak('evenChristmasBreakStart', 'evenChristmasBreakEnd', 'evenChristmasBreakParent');
    handleBreak('oddChristmasBreakStart', 'oddChristmasBreakEnd', 'oddChristmasBreakParent');
    handleBreak('evenWinterBreakStart', 'evenWinterBreakEnd', 'evenWinterBreakParent');
    handleBreak('oddWinterBreakStart', 'oddWinterBreakEnd', 'oddWinterBreakParent');
    handleBreak('evenOtherBreakStart', 'evenOtherBreakEnd', 'evenOtherBreakParent');
    handleBreak('oddOtherBreakStart', 'oddOtherBreakEnd', 'oddOtherBreakParent');
    
    // Handle current/ongoing break (uses same parent as corresponding odd-year break)
    handleCurrentBreak();
    
    handleHolidaySchedule();
    
    handleSummerSchedule();
    
    document.querySelectorAll('#calendar-container input[type="number"]').forEach(input => {
        updateCellBackground(input);
    });
    
    updateTotals();
}

function resetCalendars() {
    document.querySelectorAll('#calendar-container input[type="number"]:not(:disabled)').forEach(input => {
        input.value = '';
        updateCellDisplay(input);
    });
    updateTotals();
}

async function analyzeDocument() {
    const fileInput = document.getElementById('pdfUpload');
    if (!fileInput.files[0]) return;
    
    if (!calendarReady) {
        alert('Please complete School Calendar Settings first (upload a school calendar PDF or enable Legacy Mode) before analyzing your parenting plan.');
        return;
    }
    
    const formData = new FormData();
    formData.append('file', fileInput.files[0]);
    
    const formSnapshot = collectFormSnapshot();
    formData.append('formSnapshot', JSON.stringify(formSnapshot));
    
    document.getElementById('spinner').style.display = 'block';
    document.getElementById('analysisResults').style.display = 'none';
    document.getElementById('datesCorrectionsBanner').classList.remove('visible');
    
    try {
        const response = await fetch('/analyze_document', { method: 'POST', body: formData });
        const data = await response.json();
        
        if (response.ok && !data.error) {
            window.analysisData = data;
            const summaryText = data.shortSummary || data.summary || 'Document analyzed successfully.';
            const truncatedSummary = summaryText.length > 200 ? summaryText.substring(0, 200) + '...' : summaryText;
            
            document.getElementById('resultsContent').innerHTML = `
                <p><strong>Confidence:</strong> <span class="confidence-${data.confidence || data.parties?.confidence || 'medium'}">${data.confidence || data.parties?.confidence || 'medium'}</span></p>
                <p>${truncatedSummary}</p>
            `;
            
            const longSummary = data.longSummary || data.summary || '';
            if (longSummary.length > 200) {
                document.getElementById('resultsCollapsed').innerHTML = `<p>${longSummary}</p>`;
                document.getElementById('showMoreAnalysisBtn').style.display = 'inline-block';
            }
            
            document.getElementById('analysisResults').style.display = 'block';
            
            if (data.parties) {
                updatePartyInfo(data.parties);
            }
            
            if (data.dateCorrections && data.dateCorrections.length > 0) {
                applyDateCorrections(data.dateCorrections);
            }
            
            applyAnalysisResults();
            populateCalendars();
        } else {
            alert('Analysis failed: ' + (data.error || 'Unknown error'));
        }
    } catch (err) {
        alert('Error analyzing document: ' + err.message);
    } finally {
        document.getElementById('spinner').style.display = 'none';
    }
}

function updatePartyInfo(parties) {
    if (parties.parentA && parties.parentA.name) {
        document.getElementById('parent-a-info').innerHTML = `<strong>Parent A:</strong> ${parties.parentA.name}<br><small>${parties.parentA.role || 'Custodial'}</small>`;
    }
    if (parties.parentB && parties.parentB.name) {
        document.getElementById('parent-b-info').innerHTML = `<strong>Parent B:</strong> ${parties.parentB.name}<br><small>${parties.parentB.role || 'Non-Custodial'}</small>`;
    }
}

function applyDateCorrections(corrections) {
    let changesApplied = 0;
    const changeDetails = [];
    
    corrections.forEach(correction => {
        let changed = false;
        
        if (correction.correctedStartDate && correction.startFieldId) {
            const startEl = document.getElementById(correction.startFieldId);
            if (startEl && correction.correctedStartDate !== correction.originalStartDate) {
                startEl.value = correction.correctedStartDate;
                startEl.classList.add('ai-adjusted');
                setTimeout(() => startEl.classList.remove('ai-adjusted'), 5000);
                changed = true;
            }
        }
        
        if (correction.correctedEndDate && correction.endFieldId) {
            const endEl = document.getElementById(correction.endFieldId);
            if (endEl && correction.correctedEndDate !== correction.originalEndDate) {
                endEl.value = correction.correctedEndDate;
                endEl.classList.add('ai-adjusted');
                setTimeout(() => endEl.classList.remove('ai-adjusted'), 5000);
                changed = true;
            }
        }
        
        if (correction.correctedExchangeDate && correction.exchangeFieldId) {
            const exchEl = document.getElementById(correction.exchangeFieldId);
            if (exchEl && correction.correctedExchangeDate !== correction.originalExchangeDate) {
                exchEl.value = correction.correctedExchangeDate;
                exchEl.classList.add('ai-adjusted');
                setTimeout(() => exchEl.classList.remove('ai-adjusted'), 5000);
                changed = true;
            }
        }
        
        if (changed) {
            changesApplied++;
            changeDetails.push({
                label: correction.label,
                original: `${correction.originalStartDate || 'N/A'} to ${correction.originalEndDate || 'N/A'}`,
                corrected: `${correction.correctedStartDate || 'N/A'} to ${correction.correctedEndDate || 'N/A'}`,
                reason: correction.reason
            });
        }
    });
    
    if (changesApplied > 0) {
        const banner = document.getElementById('datesCorrectionsBanner');
        document.getElementById('correctionsSummary').textContent = 
            `Adjusted ${changesApplied} date${changesApplied > 1 ? 's' : ''} based on your parenting plan.`;
        
        let detailsHtml = '';
        changeDetails.forEach(detail => {
            detailsHtml += `
                <div class="correction-item">
                    <div class="label">${detail.label}</div>
                    <div class="dates">${detail.original} â†’ ${detail.corrected}</div>
                    <div class="reason">${detail.reason}</div>
                </div>
            `;
        });
        document.getElementById('correctionsDetails').innerHTML = detailsHtml;
        
        banner.classList.add('visible');
    }
}

function applyAnalysisResults() {
    if (!window.analysisData) return;
    const data = window.analysisData;
    
    // Helper to normalize parent values from API to form values
    function normalizeParent(val) {
        if (!val) return null;
        const v = val.toLowerCase();
        if (v === 'a' || v === 'parent-a') return 'A';
        if (v === 'b' || v === 'parent-b') return 'B';
        if (v === 'split') return 'Split';
        if (v === 'omit') return 'Omit';
        return val;
    }
    
    // Map regular weekly schedule
    if (data.regularWeeklySchedule) {
        let pattern = data.regularWeeklySchedule.pattern;
        if (pattern) {
            // Normalize pattern to match form values
            let patternLower = pattern.toLowerCase();
            if (patternLower === 'omit') pattern = 'Omit';
            else if (patternLower === 'first-third') pattern = 'first-third';
            else if (patternLower === 'second-fourth') pattern = 'second-fourth';
            else if (patternLower === 'alternating-odd') pattern = 'alternating-odd';
            else if (patternLower === 'alternating-even') pattern = 'alternating-even';
            else if (patternLower === 'every') pattern = 'every';
            const radio = document.querySelector(`input[name="weekly-schedule"][value="${pattern}"]`);
            if (radio) radio.checked = true;
        }
        if (data.regularWeeklySchedule.beginDay) {
            const startSelect = document.getElementById('weekend-start');
            if (startSelect) startSelect.value = data.regularWeeklySchedule.beginDay.toLowerCase();
        }
        if (data.regularWeeklySchedule.endDay) {
            const endSelect = document.getElementById('weekend-end');
            if (endSelect) endSelect.value = data.regularWeeklySchedule.endDay.toLowerCase();
        }
    }
    
    // Map recurring daytime periods
    if (data.recurringDaytimePeriods) {
        let freq = data.recurringDaytimePeriods.frequency;
        if (freq) {
            // Normalize frequency to match form values
            let freqLower = freq.toLowerCase();
            let freqValue = freqLower;
            if (freqLower === 'first-third-recurring') freqValue = 'first-third';
            else if (freqLower === 'second-fourth-recurring') freqValue = 'second-fourth';
            else if (freqLower === 'omit') freqValue = 'Omit';
            else if (freqLower === 'every-other') freqValue = 'every-other';
            else if (freqLower === 'every') freqValue = 'every';
            else if (freqLower === 'first-third') freqValue = 'first-third';
            else if (freqLower === 'second-fourth') freqValue = 'second-fourth';
            const radio = document.querySelector(`input[name="recurring-freq"][value="${freqValue}"]`);
            if (radio) {
                radio.checked = true;
                radio.dispatchEvent(new Event('change', { bubbles: true }));
            }
        }
        if (data.recurringDaytimePeriods.everyOtherType) {
            // Normalize to lowercase
            const everyOtherType = data.recurringDaytimePeriods.everyOtherType.toLowerCase();
            const otherRadio = document.querySelector(`input[name="every-other-type"][value="${everyOtherType}"]`);
            if (otherRadio) otherRadio.checked = true;
        }
        if (data.recurringDaytimePeriods.days) {
            const days = data.recurringDaytimePeriods.days;
            
            // Handle array format: ["wednesday", "thursday"] 
            if (Array.isArray(days)) {
                days.forEach(day => {
                    const dayLower = day.toLowerCase();
                    const checkbox = document.querySelector(`input[name="recurring-day"][value="${dayLower}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                        checkbox.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                    // Enable the hours input when day is selected
                    const hoursInput = document.getElementById(`hours-${dayLower}`);
                    if (hoursInput) {
                        hoursInput.disabled = false;
                    }
                });
            } else {
                // Handle object format: {wednesday: {enabled: true, hours: 2}}
                Object.keys(days).forEach(day => {
                    const dayData = days[day];
                    // Handle both object format {enabled: true, hours: X} and truthy check
                    const isEnabled = dayData && (dayData.enabled || dayData.hours > 0);
                    if (isEnabled) {
                        const checkbox = document.querySelector(`input[name="recurring-day"][value="${day}"]`);
                        if (checkbox) {
                            checkbox.checked = true;
                            checkbox.dispatchEvent(new Event('change', { bubbles: true }));
                        }
                        const hoursInput = document.getElementById(`hours-${day}`);
                        if (hoursInput && dayData.hours) {
                            hoursInput.value = dayData.hours;
                            hoursInput.disabled = false;
                        }
                    }
                });
            }
        }
    }
    
    // Map breaks - helper function
    function setBreakParent(breakName, yearType, parent) {
        const normalized = normalizeParent(parent);
        if (!normalized || normalized === 'Omit') return;
        const radioName = `${yearType}${breakName}Parent`;
        const radio = document.querySelector(`input[name="${radioName}"][value="${normalized}"]`);
        if (radio) radio.checked = true;
    }
    
    // Spring Break
    if (data.springBreak) {
        if (data.springBreak.evenYears) setBreakParent('SpringBreak', 'even', data.springBreak.evenYears.parent);
        if (data.springBreak.oddYears) setBreakParent('SpringBreak', 'odd', data.springBreak.oddYears.parent);
    }
    
    // Fall Break
    if (data.fallBreak) {
        if (data.fallBreak.evenYears) setBreakParent('FallBreak', 'even', data.fallBreak.evenYears.parent);
        if (data.fallBreak.oddYears) setBreakParent('FallBreak', 'odd', data.fallBreak.oddYears.parent);
    }
    
    // Helper to apply split break fields
    function applySplitBreak(breakData, prefix) {
        const parent = normalizeParent(breakData.parent);
        if (parent === 'Split') {
            toggleSplitFields(prefix);
            const firstSplit = breakData.firstSplitParent ? breakData.firstSplitParent.toUpperCase() : '';
            if (firstSplit) {
                const firstSplitEl = document.getElementById(prefix + 'FirstSplit');
                if (firstSplitEl) firstSplitEl.value = firstSplit;
            }
            if (breakData.exchangeDate) {
                const exchangeEl = document.getElementById(prefix + 'ExchangeDate');
                if (exchangeEl) exchangeEl.value = breakData.exchangeDate;
            }
        }
    }
    
    // Thanksgiving Break
    if (data.thanksgivingBreak) {
        if (data.thanksgivingBreak.evenYears) {
            setBreakParent('ThanksgivingBreak', 'even', data.thanksgivingBreak.evenYears.parent);
            applySplitBreak(data.thanksgivingBreak.evenYears, 'evenThanksgiving');
        }
        if (data.thanksgivingBreak.oddYears) {
            setBreakParent('ThanksgivingBreak', 'odd', data.thanksgivingBreak.oddYears.parent);
            applySplitBreak(data.thanksgivingBreak.oddYears, 'oddThanksgiving');
        }
    }
    
    // Christmas/Winter Break
    if (data.christmasBreak) {
        if (data.christmasBreak.evenYears) {
            setBreakParent('ChristmasBreak', 'even', data.christmasBreak.evenYears.parent);
            applySplitBreak(data.christmasBreak.evenYears, 'evenChristmas');
        }
        if (data.christmasBreak.oddYears) {
            setBreakParent('ChristmasBreak', 'odd', data.christmasBreak.oddYears.parent);
            applySplitBreak(data.christmasBreak.oddYears, 'oddChristmas');
        }
    }
    
    // February Winter Break
    if (data.winterBreak) {
        if (data.winterBreak.evenYears) setBreakParent('WinterBreak', 'even', data.winterBreak.evenYears.parent);
        if (data.winterBreak.oddYears) setBreakParent('WinterBreak', 'odd', data.winterBreak.oddYears.parent);
    }
    
    // Summer Schedule - helper to normalize summer option values
    function normalizeSummerOption(opt) {
        if (!opt) return null;
        const v = opt.toLowerCase();
        if (v === 'omit') return 'Omit';
        if (v === 'all') return 'All';
        return v; // 1week, 2weeks, 3weeks, 4weeks, alternating are lowercase
    }
    
    if (data.summerSchedule) {
        if (data.summerSchedule.evenYears && data.summerSchedule.evenYears.option) {
            const opt = normalizeSummerOption(data.summerSchedule.evenYears.option);
            if (opt) {
                const radio = document.querySelector(`input[name="evenSummerSchedule"][value="${opt}"]`);
                if (radio) radio.checked = true;
            }
        }
        if (data.summerSchedule.oddYears && data.summerSchedule.oddYears.option) {
            const opt = normalizeSummerOption(data.summerSchedule.oddYears.option);
            if (opt) {
                const radio = document.querySelector(`input[name="oddSummerSchedule"][value="${opt}"]`);
                if (radio) radio.checked = true;
            }
        }
    }
    
    // Holiday mapping - index to holiday name in response
    const holidayMap = {
        0: 'mlk',
        1: 'presidentsDay',
        2: 'easter',
        3: 'mothersDay',
        4: 'memorialDay',
        5: 'fathersDay',
        6: 'julyFourth',
        7: 'laborDay',
        8: 'halloween',
        9: 'veteransDay'
    };
    
    // Helper to normalize holiday parent values
    function normalizeHolidayParent(val) {
        if (!val) return null;
        const v = val.toLowerCase();
        if (v === 'a' || v === 'parent-a') return 'A';
        if (v === 'b' || v === 'parent-b') return 'B';
        if (v === 'omit') return 'omit';
        return val;
    }
    
    if (data.holidays) {
        Object.keys(holidayMap).forEach(idx => {
            const holidayKey = holidayMap[idx];
            const holiday = data.holidays[holidayKey];
            if (holiday) {
                // Even years
                if (holiday.evenYears) {
                    const val = normalizeHolidayParent(holiday.evenYears);
                    if (val) {
                        const radio = document.querySelector(`input[name="even-holiday-${idx}"][value="${val}"]`);
                        if (radio) radio.checked = true;
                    }
                }
                // Odd years
                if (holiday.oddYears) {
                    const val = normalizeHolidayParent(holiday.oddYears);
                    if (val) {
                        const radio = document.querySelector(`input[name="odd-holiday-${idx}"][value="${val}"]`);
                        if (radio) radio.checked = true;
                    }
                }
            }
        });
    }
    
    // School County - the user should select their school district from the dropdown
    // in legacy mode, which uses verified data from the database

    // Update party identifiers in totals section
    if (data.identifiedParties) {
        updatePartyIdentifiers(data.identifiedParties);
    }
    
    showSaveNotification('Document analyzed and settings applied!');
}

function updatePartyIdentifiers(parties) {
    const parentAInfo = document.getElementById('parent-a-info');
    const parentBInfo = document.getElementById('parent-b-info');
    
    if (parentAInfo && parties.parentA) {
        const name = parties.parentA.name || 'Unknown';
        partyAName = name;
        const role = parties.parentA.role || '';
        partyARole = role;
        parentAInfo.innerHTML = `<strong>Parent A:</strong> ${name}<br><small>${role} - Custodial</small>`;
    }
    
    if (parentBInfo && parties.parentB) {
        const name = parties.parentB.name || 'Unknown';
        partyBName = name;
        const role = parties.parentB.role || '';
        partyBRole = role;
        parentBInfo.innerHTML = `<strong>Parent B:</strong> ${name}<br><small>${role} - Non-Custodial</small>`;
    }
    
    if (parties.civilActionNumber) {
        civilActionNumber = parties.civilActionNumber;
    }
}

function populateCountyDates(county) {
    const today = getEffectiveToday();
    setSpringBreakDates(today, county);
    setFallBreakDates(today, county);
    setThanksgivingBreakDates(today, county);
    setChristmasBreakDates(today, county);
    setWinterBreakDates(today, county);
}

// Load school entities for the dropdown
async function loadSchoolEntities() {
    const select = document.getElementById('school-select');
    if (!select) return;

    try {
        const response = await fetch('/api/school-entities');
        const data = await response.json();

        if (data.success && data.entities.length > 0) {
            select.innerHTML = '<option value="">-- Select School District --</option>';

            // Group by county
            const byCounty = {};
            data.entities.forEach(entity => {
                const county = entity.county || 'Other';
                if (!byCounty[county]) byCounty[county] = [];
                byCounty[county].push(entity);
            });

            // Create optgroups by county
            Object.keys(byCounty).sort().forEach(county => {
                const optgroup = document.createElement('optgroup');
                optgroup.label = county + ' County';
                byCounty[county].forEach(entity => {
                    const option = document.createElement('option');
                    option.value = entity.id;
                    option.textContent = entity.district_name;
                    optgroup.appendChild(option);
                });
                select.appendChild(optgroup);
            });
        } else {
            select.innerHTML = '<option value="">No schools with verified data</option>';
        }
    } catch (err) {
        console.error('Error loading school entities:', err);
        select.innerHTML = '<option value="">Error loading schools</option>';
    }
}

// Load verified holidays for a school and populate the form
async function loadSchoolHolidays(entityId) {
    const statusEl = document.getElementById('schoolHolidaysStatus');
    if (statusEl) statusEl.textContent = 'Loading holidays...';

    try {
        const response = await fetch(`/api/school-holidays/${entityId}`);
        const data = await response.json();

        if (data.success) {
            const stats = applyVerifiedHolidays(data.holidays_by_year, data.district_name);
            if (statusEl) {
                const verifiedCount = stats.verified;
                const inferredCount = stats.inferred;
                let statusText = `${data.district_name}: ${verifiedCount} verified`;
                if (inferredCount > 0) {
                    statusText += `, ${inferredCount} inferred`;
                }
                statusEl.innerHTML = statusText;
            }
            populateCalendars();
            updateCalendarReadyState();
        } else {
            if (statusEl) statusEl.textContent = 'Error loading holidays';
        }
    } catch (err) {
        console.error('Error loading school holidays:', err);
        if (statusEl) statusEl.textContent = 'Error loading holidays';
    }
}

// Apply verified holidays from the database to the form fields
function applyVerifiedHolidays(holidaysByYear, districtName) {
    // Reset all break dates first
    resetHolidayDates();

    const today = getEffectiveToday();
    const currentYear = today.getFullYear();

    // Determine relevant school years (current and next)
    const currentSchoolYear = today.getMonth() >= 7 ? `${currentYear}-${currentYear + 1}` : `${currentYear - 1}-${currentYear}`;
    const nextSchoolYear = today.getMonth() >= 7 ? `${currentYear + 1}-${currentYear + 2}` : `${currentYear}-${currentYear + 1}`;

    // Map holiday names to form field prefixes
    const holidayMapping = {
        'spring break': 'SpringBreak',
        'fall break': 'FallBreak',
        'thanksgiving': 'ThanksgivingBreak',
        'christmas break': 'ChristmasBreak',
        'winter break': 'WinterBreak',
        'christmas/winter break': 'ChristmasBreak',
        'february winter break': 'WinterBreak',
        'march break': 'OtherBreak',
        'march/other break': 'OtherBreak'
    };

    // Track which breaks we've filled from verified data
    const filledBreaks = {
        even: { Spring: false, Fall: false, Thanksgiving: false, Christmas: false, Winter: false },
        odd: { Spring: false, Fall: false, Thanksgiving: false, Christmas: false, Winter: false }
    };

    // Process each school year
    Object.entries(holidaysByYear).forEach(([schoolYear, holidays]) => {
        // Determine if this is an even or odd year (based on the start year of the school year)
        const startYear = parseInt(schoolYear.split('-')[0]);
        const yearPrefix = startYear % 2 === 0 ? 'even' : 'odd';

        holidays.forEach(holiday => {
            const name = holiday.name.toLowerCase();

            // Find matching form field
            for (const [pattern, fieldSuffix] of Object.entries(holidayMapping)) {
                if (name.includes(pattern)) {
                    const startField = document.getElementById(`${yearPrefix}${fieldSuffix}Start`);
                    const endField = document.getElementById(`${yearPrefix}${fieldSuffix}End`);

                    if (startField && endField) {
                        startField.value = holiday.start_date;
                        endField.value = holiday.end_date;

                        // Mark as filled
                        const breakType = fieldSuffix.replace('Break', '');
                        if (filledBreaks[yearPrefix][breakType] !== undefined) {
                            filledBreaks[yearPrefix][breakType] = true;
                        }
                    }
                    break;
                }
            }
        });
    });

    // Fill in missing breaks with inferred dates and count them
    const inferredCount = fillMissingBreaksWithInferred(filledBreaks, districtName);

    // Count verified breaks
    let verifiedCount = 0;
    ['even', 'odd'].forEach(yp => {
        Object.values(filledBreaks[yp]).forEach(filled => {
            if (filled) verifiedCount++;
        });
    });

    return { verified: verifiedCount, inferred: inferredCount };
}

// Fill in any breaks that weren't covered by verified data with inferred/calculated dates
function fillMissingBreaksWithInferred(filledBreaks, districtName) {
    let inferredCount = 0;
    const today = getEffectiveToday();

    // Check each break type and fill if missing
    ['even', 'odd'].forEach(yearPrefix => {
        // Spring Break
        if (!filledBreaks[yearPrefix].Spring) {
            inferSpringBreakDates(yearPrefix, today);
            inferredCount++;
        }

        // Fall Break
        if (!filledBreaks[yearPrefix].Fall) {
            inferFallBreakDates(yearPrefix, today);
            inferredCount++;
        }

        // Thanksgiving Break
        if (!filledBreaks[yearPrefix].Thanksgiving) {
            inferThanksgivingBreakDates(yearPrefix, today);
            inferredCount++;
        }

        // Christmas Break
        if (!filledBreaks[yearPrefix].Christmas) {
            inferChristmasBreakDates(yearPrefix, today);
            inferredCount++;
        }

        // Winter Break (February)
        if (!filledBreaks[yearPrefix].Winter) {
            inferWinterBreakDates(yearPrefix, today);
            inferredCount++;
        }
    });

    return inferredCount;
}

// Infer Spring Break dates for a specific year type
function inferSpringBreakDates(yearPrefix, today) {
    const currentYear = today.getFullYear();
    let targetYear;

    if (yearPrefix === 'even') {
        targetYear = currentYear % 2 === 0 ? currentYear : currentYear + 1;
        if (today > new Date(targetYear, 3, 15)) targetYear += 2;
    } else {
        targetYear = currentYear % 2 === 1 ? currentYear : currentYear + 1;
        if (today > new Date(targetYear, 3, 15)) targetYear += 2;
    }

    const firstMonday = getFirstMondayInApril(targetYear);
    const fridayBefore = new Date(firstMonday);
    fridayBefore.setDate(firstMonday.getDate() - 3);
    const sundayAfter = new Date(firstMonday);
    sundayAfter.setDate(firstMonday.getDate() + 6);

    document.getElementById(`${yearPrefix}SpringBreakStart`).value = fridayBefore.toISOString().split('T')[0];
    document.getElementById(`${yearPrefix}SpringBreakEnd`).value = sundayAfter.toISOString().split('T')[0];
}

// Infer Fall Break dates for a specific year type
function inferFallBreakDates(yearPrefix, today) {
    const currentYear = today.getFullYear();
    let targetYear;

    if (yearPrefix === 'even') {
        targetYear = currentYear % 2 === 0 ? currentYear : currentYear + 1;
    } else {
        targetYear = currentYear % 2 === 1 ? currentYear : currentYear + 1;
    }

    // Default to second Monday in October pattern
    const secondMonday = getNthWeekdayOfMonth(targetYear, 9, 1, 2);
    const fridayBefore = new Date(secondMonday);
    fridayBefore.setDate(secondMonday.getDate() - 3);
    const sundayAfter = new Date(secondMonday);
    sundayAfter.setDate(secondMonday.getDate() + 6);

    document.getElementById(`${yearPrefix}FallBreakStart`).value = fridayBefore.toISOString().split('T')[0];
    document.getElementById(`${yearPrefix}FallBreakEnd`).value = sundayAfter.toISOString().split('T')[0];
}

// Infer Thanksgiving Break dates for a specific year type
function inferThanksgivingBreakDates(yearPrefix, today) {
    const currentYear = today.getFullYear();
    let targetYear;

    if (yearPrefix === 'even') {
        targetYear = currentYear % 2 === 0 ? currentYear : currentYear + 1;
    } else {
        targetYear = currentYear % 2 === 1 ? currentYear : currentYear + 1;
    }

    let thanksgiving = getLastThursdayInNovember(targetYear);
    if (thanksgiving < today) targetYear += 2;
    thanksgiving = getLastThursdayInNovember(targetYear);

    const fridayBefore = new Date(thanksgiving);
    fridayBefore.setDate(thanksgiving.getDate() - 6);
    const sundayAfter = new Date(thanksgiving);
    sundayAfter.setDate(thanksgiving.getDate() + 3);

    document.getElementById(`${yearPrefix}ThanksgivingBreakStart`).value = fridayBefore.toISOString().split('T')[0];
    document.getElementById(`${yearPrefix}ThanksgivingBreakEnd`).value = sundayAfter.toISOString().split('T')[0];
}

// Infer Christmas Break dates for a specific year type
function inferChristmasBreakDates(yearPrefix, today) {
    const currentYear = today.getFullYear();
    let targetYear;

    if (yearPrefix === 'even') {
        targetYear = currentYear % 2 === 0 ? currentYear : currentYear + 1;
    } else {
        targetYear = currentYear % 2 === 1 ? currentYear : currentYear + 1;
    }

    if (new Date(targetYear, 11, 25) < today) targetYear += 2;

    const start = new Date(targetYear, 11, 19);
    const end = new Date(targetYear + 1, 0, 3);

    document.getElementById(`${yearPrefix}ChristmasBreakStart`).value = start.toISOString().split('T')[0];
    document.getElementById(`${yearPrefix}ChristmasBreakEnd`).value = end.toISOString().split('T')[0];
}

// Infer Winter Break (February) dates for a specific year type
function inferWinterBreakDates(yearPrefix, today) {
    const currentYear = today.getFullYear();
    let targetYear;

    if (yearPrefix === 'even') {
        targetYear = currentYear % 2 === 0 ? currentYear : currentYear + 1;
    } else {
        targetYear = currentYear % 2 === 1 ? currentYear : currentYear + 1;
    }

    // MLK weekend (third Monday in January)
    const mlkDay = getNthWeekdayOfMonth(targetYear, 0, 1, 3);
    const start = new Date(mlkDay);
    start.setDate(mlkDay.getDate() - 3);
    const end = new Date(mlkDay);
    end.setDate(mlkDay.getDate() + 1);

    document.getElementById(`${yearPrefix}WinterBreakStart`).value = start.toISOString().split('T')[0];
    document.getElementById(`${yearPrefix}WinterBreakEnd`).value = end.toISOString().split('T')[0];
}

function getFirstMondayInApril(year) {
    const april1 = new Date(year, 3, 1);
    const dayOfWeek = april1.getDay();
    const daysUntilMonday = (8 - dayOfWeek) % 7;
    return new Date(year, 3, 1 + daysUntilMonday);
}

function getSecondThursdayInOctober(year) {
    const firstOctober = new Date(year, 9, 1);
    const dayOfWeek = firstOctober.getDay();
    const daysUntilFirstThursday = (4 - dayOfWeek + 7) % 7;
    return new Date(year, 9, 1 + daysUntilFirstThursday + 7);
}

function getNthWeekdayOfMonth(year, month, weekday, n) {
    const firstOfMonth = new Date(year, month, 1);
    let dayOfWeek = firstOfMonth.getDay();
    let dayOffset = (weekday - dayOfWeek + 7) % 7;
    let day = 1 + dayOffset + 7 * (n - 1);
    return new Date(year, month, day);
}

function getLastThursdayInNovember(year) {
    const lastDayNov = new Date(year, 11, 0);
    const dayOfWeek = lastDayNov.getDay();
    const daysToSubtract = (dayOfWeek - 4 + 7) % 7;
    return new Date(year, 10, lastDayNov.getDate() - daysToSubtract);
}

function setSpringBreakDates(today, county) {
    const currentYear = today.getFullYear();
    let targetYear = currentYear;
    if (today > new Date(currentYear, 3, 15)) targetYear++;
    
    const evenYear = targetYear + (targetYear % 2);
    const oddYear = evenYear - 1;
    
    const evenFirstMonday = getFirstMondayInApril(evenYear);
    const evenFridayBefore = new Date(evenFirstMonday);
    evenFridayBefore.setDate(evenFirstMonday.getDate() - 3);
    const evenSundayAfter = new Date(evenFirstMonday);
    evenSundayAfter.setDate(evenFirstMonday.getDate() + 6);
    
    const oddFirstMonday = getFirstMondayInApril(oddYear);
    const oddFridayBefore = new Date(oddFirstMonday);
    oddFridayBefore.setDate(oddFirstMonday.getDate() - 3);
    const oddSundayAfter = new Date(oddFirstMonday);
    oddSundayAfter.setDate(oddFirstMonday.getDate() + 6);
    
    document.getElementById('evenSpringBreakStart').value = evenFridayBefore.toISOString().split('T')[0];
    document.getElementById('evenSpringBreakEnd').value = evenSundayAfter.toISOString().split('T')[0];
    document.getElementById('oddSpringBreakStart').value = oddFridayBefore.toISOString().split('T')[0];
    document.getElementById('oddSpringBreakEnd').value = oddSundayAfter.toISOString().split('T')[0];
}

function setFallBreakDates(today, county) {
    const currentYear = today.getFullYear();
    let nextEvenYear = currentYear + (currentYear % 2);
    let nextOddYear = currentYear + (currentYear % 2 ? 0 : 1);
    
    if (county === 'gwinnett' || county === 'hall') {
        let evenSecondThursday = getSecondThursdayInOctober(nextEvenYear);
        let evenMondayAfter = new Date(evenSecondThursday);
        evenMondayAfter.setDate(evenSecondThursday.getDate() + 4);
        
        let oddSecondThursday = getSecondThursdayInOctober(nextOddYear);
        let oddMondayAfter = new Date(oddSecondThursday);
        oddMondayAfter.setDate(oddSecondThursday.getDate() + 4);
        
        document.getElementById('evenFallBreakStart').value = evenSecondThursday.toISOString().split('T')[0];
        document.getElementById('evenFallBreakEnd').value = evenMondayAfter.toISOString().split('T')[0];
        document.getElementById('oddFallBreakStart').value = oddSecondThursday.toISOString().split('T')[0];
        document.getElementById('oddFallBreakEnd').value = oddMondayAfter.toISOString().split('T')[0];
    } else if (county === 'fulton' || county === 'dekalb' || county === 'walton') {
        let evenSecondMonday = getNthWeekdayOfMonth(nextEvenYear, 9, 1, 2);
        let evenFridayBefore = new Date(evenSecondMonday);
        evenFridayBefore.setDate(evenSecondMonday.getDate() - 3);
        let evenSundayAfter = new Date(evenSecondMonday);
        evenSundayAfter.setDate(evenSecondMonday.getDate() + 6);
        
        let oddSecondMonday = getNthWeekdayOfMonth(nextOddYear, 9, 1, 2);
        let oddFridayBefore = new Date(oddSecondMonday);
        oddFridayBefore.setDate(oddSecondMonday.getDate() - 3);
        let oddSundayAfter = new Date(oddSecondMonday);
        oddSundayAfter.setDate(oddSecondMonday.getDate() + 6);
        
        document.getElementById('evenFallBreakStart').value = evenFridayBefore.toISOString().split('T')[0];
        document.getElementById('evenFallBreakEnd').value = evenSundayAfter.toISOString().split('T')[0];
        document.getElementById('oddFallBreakStart').value = oddFridayBefore.toISOString().split('T')[0];
        document.getElementById('oddFallBreakEnd').value = oddSundayAfter.toISOString().split('T')[0];
    } else if (county === 'cobb' || county === 'forsyth') {
        let evenFourthMonday = getNthWeekdayOfMonth(nextEvenYear, 8, 1, 4);
        let evenFridayBefore = new Date(evenFourthMonday);
        evenFridayBefore.setDate(evenFourthMonday.getDate() - 3);
        let evenSundayAfter = new Date(evenFourthMonday);
        evenSundayAfter.setDate(evenFourthMonday.getDate() + 6);
        
        let oddFourthMonday = getNthWeekdayOfMonth(nextOddYear, 8, 1, 4);
        let oddFridayBefore = new Date(oddFourthMonday);
        oddFridayBefore.setDate(oddFourthMonday.getDate() - 3);
        let oddSundayAfter = new Date(oddFourthMonday);
        oddSundayAfter.setDate(oddFourthMonday.getDate() + 6);
        
        document.getElementById('evenFallBreakStart').value = evenFridayBefore.toISOString().split('T')[0];
        document.getElementById('evenFallBreakEnd').value = evenSundayAfter.toISOString().split('T')[0];
        document.getElementById('oddFallBreakStart').value = oddFridayBefore.toISOString().split('T')[0];
        document.getElementById('oddFallBreakEnd').value = oddSundayAfter.toISOString().split('T')[0];
    } else {
        let evenFirstMonday = getNthWeekdayOfMonth(nextEvenYear, 9, 1, 1);
        let evenFridayBefore = new Date(evenFirstMonday);
        evenFridayBefore.setDate(evenFirstMonday.getDate() - 3);
        let evenSundayAfter = new Date(evenFirstMonday);
        evenSundayAfter.setDate(evenFirstMonday.getDate() + 6);
        
        let oddFirstMonday = getNthWeekdayOfMonth(nextOddYear, 9, 1, 1);
        let oddFridayBefore = new Date(oddFirstMonday);
        oddFridayBefore.setDate(oddFirstMonday.getDate() - 3);
        let oddSundayAfter = new Date(oddFirstMonday);
        oddSundayAfter.setDate(oddFirstMonday.getDate() + 6);
        
        document.getElementById('evenFallBreakStart').value = evenFridayBefore.toISOString().split('T')[0];
        document.getElementById('evenFallBreakEnd').value = evenSundayAfter.toISOString().split('T')[0];
        document.getElementById('oddFallBreakStart').value = oddFridayBefore.toISOString().split('T')[0];
        document.getElementById('oddFallBreakEnd').value = oddSundayAfter.toISOString().split('T')[0];
    }
}

function setThanksgivingBreakDates(today, county) {
    const currentYear = today.getFullYear();
    let evenYear = currentYear + (currentYear % 2 === 0 ? 0 : 1);
    let oddYear = currentYear + (currentYear % 2 === 1 ? 0 : 1);
    
    let evenThanksgiving = getLastThursdayInNovember(evenYear);
    if (evenThanksgiving < today) { evenYear += 2; evenThanksgiving = getLastThursdayInNovember(evenYear); }
    
    let oddThanksgiving = getLastThursdayInNovember(oddYear);
    if (oddThanksgiving < today) { oddYear += 2; oddThanksgiving = getLastThursdayInNovember(oddYear); }
    
    const evenFridayBefore = new Date(evenThanksgiving);
    evenFridayBefore.setDate(evenThanksgiving.getDate() - 6);
    const evenSundayAfter = new Date(evenThanksgiving);
    evenSundayAfter.setDate(evenThanksgiving.getDate() + 3);
    
    const oddFridayBefore = new Date(oddThanksgiving);
    oddFridayBefore.setDate(oddThanksgiving.getDate() - 6);
    const oddSundayAfter = new Date(oddThanksgiving);
    oddSundayAfter.setDate(oddThanksgiving.getDate() + 3);
    
    document.getElementById('evenThanksgivingBreakStart').value = evenFridayBefore.toISOString().split('T')[0];
    document.getElementById('evenThanksgivingBreakEnd').value = evenSundayAfter.toISOString().split('T')[0];
    document.getElementById('oddThanksgivingBreakStart').value = oddFridayBefore.toISOString().split('T')[0];
    document.getElementById('oddThanksgivingBreakEnd').value = oddSundayAfter.toISOString().split('T')[0];
}

function setChristmasBreakDates(today, county) {
    const currentYear = today.getFullYear();
    let evenYear = currentYear + (currentYear % 2 === 0 ? 0 : 1);
    let oddYear = currentYear + (currentYear % 2 === 1 ? 0 : 1);
    
    if (new Date(evenYear, 11, 25) < today) evenYear += 2;
    if (new Date(oddYear, 11, 25) < today) oddYear += 2;
    
    const evenStart = new Date(evenYear, 11, 19);
    const evenEnd = new Date(evenYear + 1, 0, 3);
    const oddStart = new Date(oddYear, 11, 19);
    const oddEnd = new Date(oddYear + 1, 0, 3);
    
    document.getElementById('evenChristmasBreakStart').value = evenStart.toISOString().split('T')[0];
    document.getElementById('evenChristmasBreakEnd').value = evenEnd.toISOString().split('T')[0];
    document.getElementById('oddChristmasBreakStart').value = oddStart.toISOString().split('T')[0];
    document.getElementById('oddChristmasBreakEnd').value = oddEnd.toISOString().split('T')[0];
}

function setWinterBreakDates(today, county) {
    const currentYear = today.getFullYear();
    let evenYear = currentYear + (currentYear % 2 === 0 ? 0 : 1);
    let oddYear = currentYear + (currentYear % 2 === 1 ? 0 : 1);
    
    const evenMLK = getNthWeekdayOfMonth(evenYear, 0, 1, 3);
    const oddMLK = getNthWeekdayOfMonth(oddYear, 0, 1, 3);
    
    const evenStart = new Date(evenMLK);
    evenStart.setDate(evenMLK.getDate() - 3);
    const evenEnd = new Date(evenMLK);
    evenEnd.setDate(evenMLK.getDate() + 1);
    
    const oddStart = new Date(oddMLK);
    oddStart.setDate(oddMLK.getDate() - 3);
    const oddEnd = new Date(oddMLK);
    oddEnd.setDate(oddMLK.getDate() + 1);
    
    document.getElementById('evenWinterBreakStart').value = evenStart.toISOString().split('T')[0];
    document.getElementById('evenWinterBreakEnd').value = evenEnd.toISOString().split('T')[0];
    document.getElementById('oddWinterBreakStart').value = oddStart.toISOString().split('T')[0];
    document.getElementById('oddWinterBreakEnd').value = oddEnd.toISOString().split('T')[0];
}

let partyAName = '';
let partyBName = '';
let partyARole = '';
let partyBRole = '';
let civilActionNumber = '';

function getDefaultSaveName() {
    let name = '';
    if (partyAName || partyBName) {
        const lastNameA = partyAName ? partyAName.split(' ').pop() : 'PartyA';
        const lastNameB = partyBName ? partyBName.split(' ').pop() : 'PartyB';
        name = `${lastNameA} v ${lastNameB}`;
        if (civilActionNumber) {
            name += ` ${civilActionNumber}`;
        }
    }
    return name;
}

function openSaveModal() {
    const modal = document.getElementById('saveModal');
    if (!modal) return;
    modal.style.display = 'flex';
    const defaultName = getDefaultSaveName();
    const input = document.getElementById('saveNameInput');
    if (input) {
        input.value = defaultName;
        input.focus();
    }
}

function closeSaveModal() {
    const modal = document.getElementById('saveModal');
    if (modal) modal.style.display = 'none';
}

function showSaveNotification(message, isError = false) {
    const notif = document.getElementById('saveNotification');
    notif.textContent = message;
    notif.style.background = isError ? '#e74c3c' : '#27ae60';
    notif.style.opacity = '1';
    notif.style.transform = 'translateX(0)';
    setTimeout(() => {
        notif.style.opacity = '0';
        notif.style.transform = 'translateX(100%)';
    }, 3000);
}

function collectFormState() {
    const state = {
        weeklySchedule: document.querySelector('input[name="weekly-schedule"]:checked')?.value || 'Omit',
        weekendStart: document.getElementById('weekend-start').value,
        weekendEnd: document.getElementById('weekend-end').value,
        recurringFreq: document.querySelector('input[name="recurring-freq"]:checked')?.value || 'Omit',
        everyOtherType: document.querySelector('input[name="every-other-type"]:checked')?.value || 'odd',
        schoolEntityId: document.getElementById('school-select')?.value || '',
        recurringDays: {},
        breaks: {},
        summerSchedule: {
            even: document.querySelector('input[name="evenSummerSchedule"]:checked')?.value || 'Omit',
            odd: document.querySelector('input[name="oddSummerSchedule"]:checked')?.value || 'Omit'
        },
        holidays: { even: [], odd: [] }
    };
    
    ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'].forEach(day => {
        const cb = document.querySelector(`input[name="recurring-day"][value="${day}"]`);
        const hours = document.getElementById('hours-' + day);
        state.recurringDays[day] = {
            enabled: cb?.checked || false,
            hours: hours?.value || ''
        };
    });
    
    const breakTypes = ['Spring', 'Fall', 'Thanksgiving', 'Christmas', 'Winter', 'Other'];
    const yearTypes = ['even', 'odd'];
    
    const splittableBreaks = ['Thanksgiving', 'Christmas'];
    breakTypes.forEach(bt => {
        yearTypes.forEach(yt => {
            const prefix = yt + bt + 'Break';
            const parent = document.querySelector(`input[name="${prefix}Parent"]:checked`)?.value || 'Omit';
            const start = document.getElementById(prefix + 'Start')?.value || '';
            const end = document.getElementById(prefix + 'End')?.value || '';
            const breakData = { parent, start, end };
            if (splittableBreaks.includes(bt)) {
                const splitPrefix = yt + bt;
                breakData.exchangeDate = document.getElementById(splitPrefix + 'ExchangeDate')?.value || '';
                breakData.firstSplitParent = document.getElementById(splitPrefix + 'FirstSplit')?.value || '';
            }
            state.breaks[prefix] = breakData;
        });
    });
    
    HOLIDAYS.forEach((h, idx) => {
        const evenValue = document.querySelector(`input[name="even-holiday-${idx}"]:checked`)?.value || 'omit';
        const evenStart = document.getElementById(`evenBegin${idx}`)?.value || '';
        const evenEnd = document.getElementById(`evenEnd${idx}`)?.value || '';
        state.holidays.even.push({ value: evenValue, start: evenStart, end: evenEnd });
        
        const oddValue = document.querySelector(`input[name="odd-holiday-${idx}"]:checked`)?.value || 'omit';
        const oddStart = document.getElementById(`oddBegin${idx}`)?.value || '';
        const oddEnd = document.getElementById(`oddEnd${idx}`)?.value || '';
        state.holidays.odd.push({ value: oddValue, start: oddStart, end: oddEnd });
    });
    
    state.partyIdentifiers = {
        parentA: { name: partyAName, role: partyARole },
        parentB: { name: partyBName, role: partyBRole },
        civilActionNumber: civilActionNumber
    };
    
    return state;
}

function restoreFormState(state) {
    if (!state) return;
    
    const weeklyRadio = document.querySelector(`input[name="weekly-schedule"][value="${state.weeklySchedule}"]`);
    if (weeklyRadio) weeklyRadio.checked = true;
    
    if (state.weekendStart) document.getElementById('weekend-start').value = state.weekendStart;
    if (state.weekendEnd) document.getElementById('weekend-end').value = state.weekendEnd;
    
    const recurringRadio = document.querySelector(`input[name="recurring-freq"][value="${state.recurringFreq}"]`);
    if (recurringRadio) recurringRadio.checked = true;
    
    if (state.recurringFreq === 'every-other') {
        document.getElementById('every-other-options').style.display = 'block';
    }
    const everyOtherRadio = document.querySelector(`input[name="every-other-type"][value="${state.everyOtherType}"]`);
    if (everyOtherRadio) everyOtherRadio.checked = true;
    
    if (state.schoolEntityId) {
        const schoolSelect = document.getElementById('school-select');
        if (schoolSelect) {
            schoolSelect.value = state.schoolEntityId;
            // Load the holidays for this school
            loadSchoolHolidays(state.schoolEntityId);
        }
    }

    if (state.recurringDays) {
        Object.keys(state.recurringDays).forEach(day => {
            const cb = document.querySelector(`input[name="recurring-day"][value="${day}"]`);
            const hours = document.getElementById('hours-' + day);
            if (cb && state.recurringDays[day]) {
                cb.checked = state.recurringDays[day].enabled;
                if (hours) {
                    hours.disabled = !state.recurringDays[day].enabled;
                    hours.value = state.recurringDays[day].hours || '';
                }
            }
        });
    }
    
    if (state.breaks) {
        Object.keys(state.breaks).forEach(prefix => {
            const data = state.breaks[prefix];
            const parentRadio = document.querySelector(`input[name="${prefix}Parent"][value="${data.parent}"]`);
            if (parentRadio) parentRadio.checked = true;
            const startEl = document.getElementById(prefix + 'Start');
            if (startEl) startEl.value = data.start;
            const endEl = document.getElementById(prefix + 'End');
            if (endEl) endEl.value = data.end;
            const splitPrefix = prefix.replace('Break', '');
            if (data.exchangeDate !== undefined) {
                const exchangeEl = document.getElementById(splitPrefix + 'ExchangeDate');
                if (exchangeEl) exchangeEl.value = data.exchangeDate;
            }
            if (data.firstSplitParent !== undefined) {
                const firstSplitEl = document.getElementById(splitPrefix + 'FirstSplit');
                if (firstSplitEl) firstSplitEl.value = data.firstSplitParent;
            }
            if (data.parent === 'Split') {
                toggleSplitFields(splitPrefix);
            }
        });
    }
    
    if (state.summerSchedule) {
        const evenRadio = document.querySelector(`input[name="evenSummerSchedule"][value="${state.summerSchedule.even}"]`);
        if (evenRadio) evenRadio.checked = true;
        const oddRadio = document.querySelector(`input[name="oddSummerSchedule"][value="${state.summerSchedule.odd}"]`);
        if (oddRadio) oddRadio.checked = true;
    }
    
    if (state.holidays) {
        state.holidays.even.forEach((h, idx) => {
            const radio = document.querySelector(`input[name="even-holiday-${idx}"][value="${h.value}"]`);
            if (radio) radio.checked = true;
            const startEl = document.getElementById(`evenBegin${idx}`);
            if (startEl) startEl.value = h.start;
            const endEl = document.getElementById(`evenEnd${idx}`);
            if (endEl) endEl.value = h.end;
        });
        state.holidays.odd.forEach((h, idx) => {
            const radio = document.querySelector(`input[name="odd-holiday-${idx}"][value="${h.value}"]`);
            if (radio) radio.checked = true;
            const startEl = document.getElementById(`oddBegin${idx}`);
            if (startEl) startEl.value = h.start;
            const endEl = document.getElementById(`oddEnd${idx}`);
            if (endEl) endEl.value = h.end;
        });
    }
    
    if (state.partyIdentifiers) {
        const parties = {
            parentA: state.partyIdentifiers.parentA || {},
            parentB: state.partyIdentifiers.parentB || {},
            civilActionNumber: state.partyIdentifiers.civilActionNumber || ''
        };
        updatePartyIdentifiers(parties);
    }
}

async function saveConfiguration() {
    const name = document.getElementById('saveNameInput').value.trim();
    if (!name) {
        showSaveNotification('Please enter a name for this save', true);
        return;
    }
    
    const formState = collectFormState();
    
    try {
        const response = await fetch('/api/saves', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name: name,
                config_data: JSON.stringify(formState)
            })
        });
        
        if (response.ok) {
            closeSaveModal();
            showSaveNotification('Configuration saved successfully!');
        } else {
            const data = await response.json();
            showSaveNotification(data.error || 'Failed to save', true);
        }
    } catch (err) {
        showSaveNotification('Error saving configuration', true);
    }
}

async function loadSavedConfiguration(saveId) {
    try {
        const response = await fetch(`/api/saves/${saveId}`);
        if (response.ok) {
            const save = await response.json();
            const state = JSON.parse(save.config_data);
            restoreFormState(state);
            showSaveNotification(`Loaded: ${save.name}`);
            populateCalendars();
        } else {
            showSaveNotification('Failed to load save', true);
        }
    } catch (err) {
        showSaveNotification('Error loading configuration', true);
    }
}

function checkForLoadParameter() {
    const params = new URLSearchParams(window.location.search);
    const loadId = params.get('load');
    if (loadId) {
        loadSavedConfiguration(loadId);
        window.history.replaceState({}, '', window.location.pathname);
    }
}

async function submitGuestEmail() {
    const email = document.getElementById('guestEmailInput').value.trim();
    const errorDiv = document.getElementById('emailError');
    
    if (!email || !email.includes('@')) {
        errorDiv.textContent = 'Please enter a valid email address.';
        errorDiv.style.display = 'block';
        return;
    }
    
    try {
        const response = await fetch('/api/guest/submit-email', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: email })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            document.getElementById('emailModal').style.display = 'none';
            document.getElementById('guestTokenCount').textContent = data.tokens;
            showSaveNotification(data.message);
        } else {
            errorDiv.textContent = data.error || 'Failed to submit email.';
            errorDiv.style.display = 'block';
        }
    } catch (err) {
        errorDiv.textContent = 'Error submitting email. Please try again.';
        errorDiv.style.display = 'block';
    }
}

async function submitGuestPhone() {
    const phone = document.getElementById('guestPhoneInput').value.trim();
    const permission = document.getElementById('contactPermission').checked;
    const errorDiv = document.getElementById('phoneError');
    
    if (!phone || phone.length < 7) {
        errorDiv.textContent = 'Please enter a valid phone number.';
        errorDiv.style.display = 'block';
        return;
    }
    
    if (!permission) {
        errorDiv.textContent = 'Please check the permission box to receive tokens.';
        errorDiv.style.display = 'block';
        return;
    }
    
    try {
        const response = await fetch('/api/guest/submit-phone', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ phone: phone, contact_permission: permission })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            document.getElementById('phoneModal').style.display = 'none';
            document.getElementById('guestTokenCount').textContent = data.tokens;
            showSaveNotification(data.message);
        } else {
            errorDiv.textContent = data.error || 'Failed to submit phone.';
            errorDiv.style.display = 'block';
        }
    } catch (err) {
        errorDiv.textContent = 'Error submitting phone. Please try again.';
        errorDiv.style.display = 'block';
    }
}

document.addEventListener('DOMContentLoaded', function() {
    init();
    checkForLoadParameter();
    initFaqToggle();
    initManualConfigToggle();
    initTopSaveButton();
});

function initManualConfigToggle() {
    const toggle = document.getElementById('manualConfigToggle');
    const configSection = document.getElementById('manualConfigSection');
    const breaksSection = document.getElementById('breaksAndHolidaysSection');
    
    if (toggle && configSection && breaksSection) {
        const toggleKnob = document.createElement('span');
        toggleKnob.style.cssText = 'position: absolute; width: 18px; height: 18px; background: white; border-radius: 50%; top: 2px; left: 2px; transition: all 0.3s;';
        toggle.appendChild(toggleKnob);
        
        const style = document.createElement('style');
        style.textContent = '#manualConfigToggle.active span { left: 22px !important; } #manualConfigToggle:not(.active) span { left: 2px !important; }';
        document.head.appendChild(style);
        
        toggle.addEventListener('click', function() {
            toggle.classList.toggle('active');
            const isActive = toggle.classList.contains('active');
            
            if (isActive) {
                toggle.style.background = '#27ae60';
                configSection.style.display = 'grid';
                breaksSection.style.display = 'block';
            } else {
                toggle.style.background = '#ccc';
                configSection.style.display = 'none';
                breaksSection.style.display = 'none';
            }
        });
    }
}

function initTopSaveButton() {
    const topSaveBtn = document.getElementById('save-btn-top');
    if (topSaveBtn) {
        topSaveBtn.addEventListener('click', saveConfiguration);
    }
}

function initFaqToggle() {
    const faqQuestions = document.querySelectorAll('.faq-question');
    faqQuestions.forEach(question => {
        question.addEventListener('click', function() {
            const faqItem = this.parentElement;
            faqItem.classList.toggle('active');
        });
    });
}

function toggleDefinitionBox() {
    const box = document.getElementById('definitionBox');
    if (box) {
        box.classList.toggle('expanded');
    }
}
</script>

<!-- FAQ Schema (JSON-LD) -->
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "FAQPage",
    "mainEntity": [
        {
            "@type": "Question",
            "name": "How do I calculate parenting time days in Georgia?",
            "acceptedAnswer": {
                "@type": "Answer",
                "text": "To calculate parenting time days in Georgia for child support purposes, count each overnight the noncustodial parent has with the child over a 12-month period. Georgia uses the overnight rule, meaning the parent with whom the child sleeps receives credit for that day. For recurring daytime periods without overnights, divide total annual hours by 24 to get fractional day credit. Courts require a two-year average to account for alternating holidays."
            }
        },
        {
            "@type": "Question",
            "name": "What is the parenting time adjustment in Georgia child support?",
            "acceptedAnswer": {
                "@type": "Answer",
                "text": "The parenting time adjustment in Georgia child support allows the presumptive support amount to be adjusted when the noncustodial parent has significant parenting time. Effective January 1, 2026, Georgia law requires courts to calculate this mandatory adjustment using Schedule C. The adjustment reduces the noncustodial parent's obligation based on the percentage of time the child spends with them, replacing the former discretionary parenting time deviation."
            }
        },
        {
            "@type": "Question",
            "name": "How many parenting time days triggers an adjustment in Georgia?",
            "acceptedAnswer": {
                "@type": "Answer",
                "text": "Under OCGA Â§ 19-6-15(b)(5.1), the parenting time adjustment may apply when parenting time exceeds the threshold specified in the statute. The adjustment percentage is calculated based on the noncustodial parent's share of annual parenting days divided by 365. Courts average parenting time over a 24-month period to determine the applicable adjustment on Schedule C."
            }
        },
        {
            "@type": "Question",
            "name": "Does Georgia count overnights or 24-hour periods?",
            "acceptedAnswer": {
                "@type": "Answer",
                "text": "Georgia counts overnights (not 24-hour periods) when calculating parenting time days for child support adjustment purposes. Under OCGA Â§ 19-6-15, 'days' means: (i) the total number of overnights a parent spends with the child, or (ii) for regular recurring daytime periods, the total hours divided by 24. The overnight rule determines which parent receives credit for each calendar day."
            }
        },
        {
            "@type": "Question",
            "name": "How do holidays affect parenting time calculations in Georgia?",
            "acceptedAnswer": {
                "@type": "Answer",
                "text": "Holidays affect Georgia parenting time calculations by adding or subtracting days from the regular schedule. Most parenting plans alternate holidays between parents in even and odd years. This is why Georgia requires courts to average parenting time over a two-year periodâ€”to capture the full effect of alternating holiday schedules."
            }
        },
        {
            "@type": "Question",
            "name": "Can I use a calculator for Georgia parenting time?",
            "acceptedAnswer": {
                "@type": "Answer",
                "text": "Yes, you can use a Georgia-specific parenting time calculator to count your annual parenting time days. The calculator should account for your regular schedule, holidays, and school calendar. This tool generates 24 consecutive months of calendars, applies the overnight rule, handles alternating even/odd year holidays, and produces the yearly average needed for Child Support Schedule C."
            }
        },
        {
            "@type": "Question",
            "name": "What is Schedule C in Georgia child support?",
            "acceptedAnswer": {
                "@type": "Answer",
                "text": "Child Support Schedule C is the official Georgia worksheet for calculating the parenting time adjustment. Parents enter their annual parenting days (averaged over 2 years), and Schedule C calculates the percentage adjustment applied to the basic child support obligation. The yearly average from this calculator is entered directly on Schedule C."
            }
        },
        {
            "@type": "Question",
            "name": "What changed in Georgia child support law in 2026?",
            "acceptedAnswer": {
                "@type": "Answer",
                "text": "Effective January 1, 2026, Georgia Senate Bill 454 replaced the discretionary parenting time deviation with a mandatory parenting time adjustment. Courts must now calculate and apply the adjustment using Schedule C, making the process formula-driven rather than judge-discretionary. This ensures consistent treatment of parenting time across all Georgia child support cases."
            }
        },
        {
            "@type": "Question",
            "name": "Do summer vacation days count toward parenting time in Georgia?",
            "acceptedAnswer": {
                "@type": "Answer",
                "text": "Yes, summer vacation overnights count toward the noncustodial parent's parenting time. Extended summer periods are a significant factor in the two-year average, often substantially increasing the noncustodial parent's percentage and reducing their child support obligation through the Schedule C adjustment."
            }
        },
        {
            "@type": "Question",
            "name": "Can I use this parenting time calculator for court?",
            "acceptedAnswer": {
                "@type": "Answer",
                "text": "This calculator generates court-ready documentation showing parenting time calculations over 24 months. While it produces the yearly average needed for Schedule C, the official Child Support Worksheets must still be completed. The calendar serves as supporting documentation for your Schedule C entries and can be printed without educational content for a clean court presentation."
            }
        }
    ]
}
</script>

<!-- SoftwareApplication Schema (JSON-LD) -->
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "SoftwareApplication",
    "name": "Georgia Parenting Time Calculator",
    "description": "Free online calculator to count parenting time days in Georgia for child support adjustments under OCGA Â§ 19-6-15. Customizable for school calendars, holidays, and specific custody schedules.",
    "applicationCategory": "UtilitiesApplication",
    "operatingSystem": "Web browser",
    "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
    },
    "featureList": [
        "Count annual parenting time days",
        "Customize holiday schedules",
        "Import school calendar dates",
        "Generate printable court report",
        "Compare different custody schedules"
    ],
    "softwareVersion": "2.0",
    "datePublished": "2024-01-01",
    "dateModified": "2025-01-01",
    "author": {
        "@type": "Organization",
        "name": "Parenting Time Calendar Tool"
    }
}
</script>

<!-- WebPage Schema with Speakable -->
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "WebPage",
    "name": "Georgia Parenting Time Calculator",
    "description": "Calculate parenting time days for Georgia child support adjustments",
    "speakable": {
        "@type": "SpeakableSpecification",
        "cssSelector": [".definition-box", ".faq-answer"]
    }
}
</script>

<!-- BreadcrumbList Schema -->
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
        {
            "@type": "ListItem",
            "position": 1,
            "name": "Home",
            "item": "{{ request.url_root }}"
        },
        {
            "@type": "ListItem",
            "position": 2,
            "name": "Georgia Parenting Time Calculator",
            "item": "{{ request.url_root }}ai-calendar"
        }
    ]
}
</script>
{% endblock %}
