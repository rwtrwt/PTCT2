{% extends "base.html" %}

{% block content %}
<h1>Subscription</h1>
<div class="subscription-container">
    <div class="subscription-info">
        {% if current_user.is_authenticated %}
            <h2>Your Current Plan: {{ current_user.subscription_type.capitalize() }}</h2>
            {% if current_user.subscription_type == 'free' %}
                <p>Upgrade to our Premium plan to unlock advanced features!</p>
            {% else %}
                <p>Thank you for being a premium subscriber!</p>
            {% endif %}
        {% else %}
            <h2>Choose Your Plan</h2>
            <p>Upgrade to our Premium plan to unlock advanced features!</p>
        {% endif %}
    </div>

    <div class="subscription-plans">
        {% if not current_user.is_authenticated or current_user.subscription_type == 'free' %}
        <div class="plan free">
            <h3>Free Plan</h3>
            <ul>
                <li>Basic calendar tool</li>
                <li>FREE to the Public at no cost to the Taxpayer</li>
                <li>Starts with <strong>10 tokens</strong></li>
                <li>No customization options</li>
                <li>The Calendar Tool will give attorney Russell Taylor credit for developing this software.</li>
            </ul>
            <p class="price">$0 / month</p>
            {% if current_user.is_authenticated %}
                <button disabled>Current Plan</button>
            {% else %}
                <a href="{{ url_for('auth.register') }}" class="upgrade-button" style="display: inline-block; text-decoration: none; padding: 10px 20px; background: #6b7280; color: white; border-radius: 6px;">Register Free</a>
            {% endif %}
            
            <div style="margin-top: 20px; padding: 15px; background: #f0f9ff; border-radius: 8px; text-align: left;">
                <h4 style="margin: 0 0 10px 0; color: #1f2937; font-size: 1em;">Ways to Get More Tokens:</h4>
                <ul style="margin: 0; padding-left: 20px; color: #4b5563; font-size: 0.9em;">
                    {% if current_user.is_authenticated %}
                    <li><strong>Refer a Friend:</strong> Earn 20 tokens for each signup via your <a href="{{ url_for('main.profile') }}">referral link</a></li>
                    {% else %}
                    <li><strong>Refer a Friend:</strong> Earn 20 tokens for each signup via your referral link (after registering)</li>
                    {% endif %}
                    <li><strong>Purchase Tokens:</strong> Buy 10 tokens for $50</li>
                    <li><strong>Subscribe to Premium:</strong> Unlimited access with Premium Attorney Plan</li>
                </ul>
            </div>
        </div>
        {% endif %}


        {% if current_user.is_authenticated and current_user.subscription_type == 'free' %}
        <div class="plan free">
            <h3>Purchase Token</h3>
            <ul>
                <li>Tokens can be purchased in bundles of 10 for $50.</li>

            </ul>
            <p class="price"></p>
            <button id="checkout-button1" class="upgrade-button">Upgrade Now</button>
        </div>
        {% endif %}


        <div class="plan premium">
            <h3>Premium Attorney Plan</h3>
            <ul>
                <li>Advanced calendar generator</li>
                <li>AI-Powered Parenting Plan Analyzer (Premium Exclusive)</li>
                <li>Remove Citation to Tool's Developer</li>
                <li>Customize the "H4" tag on the Calendar Tool page to name YOUR law firm.</li>
            </ul>
            <p class="price">
                <span style="text-decoration: line-through; color: #999;">$19.84 / month</span><br>
                <span style="color: #22c55e; font-weight: bold;">First month only $0.99!</span><br>
                {% if promo_remaining is defined and promo_remaining > 0 %}
                <small style="color: #e74c3c; font-weight: bold; font-size: 0.95em;">Only {{ promo_remaining }} discount{{ 's' if promo_remaining != 1 else '' }} remaining!</small>
                {% elif promo_remaining is defined and promo_remaining == 0 %}
                <small style="color: #666;">Promotional pricing has ended</small>
                {% else %}
                <small style="color: #666;">Limited to first 50 subscribers</small>
                {% endif %}
            </p>
            {% if not current_user.is_authenticated %}
                <a href="{{ url_for('auth.register') }}" class="upgrade-button" style="display: inline-block; text-decoration: none;">Register to Subscribe</a>
            {% elif current_user.subscription_type == 'free' %}
                <button id="checkout-button" class="upgrade-button">Upgrade Now</button>
            {% elif current_user.subscription_type == 'government' %}
                <p style="color: #22c55e; font-weight: bold; margin-top: 1rem;">Government Account - Full Access</p>
            {% else %}
                <p style="color: #22c55e; font-weight: bold; margin-top: 1rem;">You're Subscribed!</p>
            {% endif %}
        </div>
    </div>
</div>

{% if current_user.is_authenticated and current_user.subscription_type == 'paid' %}
<div class="manage-subscription">
    <a href="{{ url_for('payments.payment_cancel') }}" class="btn btn-secondary">Cancel Subscription</a>
</div>
{% endif %}


<script src="https://js.stripe.com/v3/"></script>
<script>
    var checkoutButton = document.getElementById('checkout-button');
    if (checkoutButton) {
        checkoutButton.addEventListener('click', function() {
            fetch(`${window.location.origin}/create-checkout-session`, {
                method: 'POST',
            })
            .then(function(response) {
                if (!response.ok) {
                    if (response.status === 401) {
                        // Redirect to login page if the user is not authenticated
                        window.location.href = '/login';
                    } else {
                        return response.json().then(function(errorData) {
                            throw new Error(errorData.error);
                        });
                    }
                }
                return response.json();
            })
            .then(function(session) {
                if (session.sessionId) {
                    window.location.href = session.sessionId;
                } else {
                    throw new Error('Invalid session response');
                }
            })
            .catch(function(error) {
                console.error('Error:', error);
                alert('An error occurred: ' + error.message);
            });
        });
    }
</script>


<script>
    var checkoutButton1 = document.getElementById('checkout-button1');
    if (checkoutButton1) {
        checkoutButton1.addEventListener('click', function() {
            fetch(`${window.location.origin}/create-checkout-session_1`, {
                method: 'POST',
            })
            .then(function(response) {
                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = '/login';
                    } else {
                        return response.json().then(function(errorData) {
                            throw new Error(errorData.error);
                        });
                    }
                }
                return response.json();
            })
            .then(function(session) {
                if (session.sessionId) {
                    window.location.href = session.sessionId;
                } else {
                    throw new Error('Invalid session response');
                }
            })
            .catch(function(error) {
                console.error('Error:', error);
                alert('An error occurred: ' + error.message);
            });
        });
    }
</script>
{% endblock %}
